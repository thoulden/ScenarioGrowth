<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scenario Growth Model</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- Model core (no DOM dependencies, loaded first) -->
    <script src="model/constants.js"></script>
    <script src="model/ces.js"></script>
    <script src="model/land.js"></script>
    <script src="model/production.js"></script>
    <script src="model/solvers.js"></script>
    <script src="model/labor.js"></script>
    <script src="model/distribution.js"></script>
    <!-- Chart theme, helpers, and individual chart modules -->
    <script src="charts/theme.js"></script>
    <script src="charts/wagesChart.js"></script>
    <script src="charts/rentalCostChart.js"></script>
    <script src="charts/muChart.js"></script>
    <script src="charts/ellChart.js"></script>
    <script src="charts/capitalChart.js"></script>
    <script src="charts/interestChart.js"></script>
    <script src="charts/factorIncomeChart.js"></script>
    <script src="charts/techChart.js"></script>
    <script src="charts/laborChart.js"></script>
    <script src="charts/wageIncomeChart.js"></script>
    <script src="charts/ubiTransferChart.js"></script>
    <script src="charts/outputChart.js"></script>
    <script src="charts/gwpBreakdownChart.js"></script>
    <script src="charts/laborProductivityChart.js"></script>
    <script src="charts/landRentChart.js"></script>
    <script src="charts/landUseShareChart.js"></script>
    <script src="charts/landIncomeShareChart.js"></script>
    <script src="charts/consumerBudgetChart.js"></script>
    <script src="charts/incomeCompChart.js"></script>
    <script src="charts/incomeDistChart.js"></script>
    <script src="charts/netWorthChart.js"></script>
    <script src="charts/giniChart.js"></script>
    <script src="charts/createCharts.js"></script>
    <script src="charts/createDistributionCharts.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: "Courier New", Courier, monospace, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            background: #FFFEF8;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .file-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .params-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .param-group {
            display: flex;
            flex-direction: column;
        }
        .param-group label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #555;
        }
        .param-group input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .param-group small {
            color: #888;
            margin-top: 3px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .template-btn {
            background: #28a745;
            margin-top: 0;
        }
        .template-btn:hover {
            background: #1e7e34;
        }
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        @media (max-width: 900px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }
        .chart-container {
            background: #FFFEF8;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            height: 420px;
            display: flex;
            flex-direction: column;
        }
        .chart-container canvas {
            flex: 1;
            min-height: 0;
        }
        .chart-container h3 {
            margin-top: 0;
            margin-bottom: 8px;
            color: #555;
            text-align: center;
            font-size: 13px;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .status.error {
            background: #fee;
            color: #c00;
        }
        .status.success {
            background: #efe;
            color: #060;
        }
        .status.info {
            background: #eef;
            color: #006;
        }
        .hidden {
            display: none;
        }
        .data-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .data-section h2 {
            margin-top: 0;
            color: #555;
        }
        #scenarioTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        #scenarioTable th,
        #scenarioTable td {
            padding: 4px 2px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }
        #scenarioTable th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        #scenarioTable td:first-child,
        #scenarioTable th:first-child {
            text-align: left;
            font-weight: 500;
            white-space: nowrap;
            padding-right: 10px;
        }
        #scenarioTable input {
            width: 72px;
            border: 1px solid transparent;
            background: transparent;
            text-align: right;
            font-size: 12px;
            font-family: inherit;
            padding: 3px 4px;
            border-radius: 3px;
        }
        #scenarioTable input:hover {
            border-color: #ccc;
            background: #fafafa;
        }
        #scenarioTable input:focus {
            border-color: #007bff;
            background: #fff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.15);
        }
        #scenarioTable input.invalid {
            border-color: #dc3545;
            background: #fff5f5;
        }
        #scenarioTable .derived-cell {
            display: inline-block;
            width: 72px;
            text-align: right;
            font-size: 12px;
            padding: 3px 4px;
            color: #555;
        }
        .upload-label:hover {
            background: #5a6268 !important;
        }
        .results-table {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 20px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        th, td {
            padding: 8px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
        }
        td:first-child, th:first-child {
            text-align: left;
        }
        /* App layout: main content + side panel */
        .app-layout {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        .main-content {
            flex: 1;
            min-width: 0;
        }

        /* Collapsible side panel (fixed drawer on right) */
        .side-panel {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 620px;
            background: #FFFEF8;
            border-left: 1px solid #ccc;
            padding: 20px;
            overflow-y: auto;
            z-index: 200;
            box-shadow: -4px 0 16px rgba(0,0,0,0.15);
            transform: translateX(0);
            transition: transform 0.3s ease;
        }
        .side-panel.collapsed {
            transform: translateX(100%);
            box-shadow: none;
        }
        .side-panel h3 {
            margin-top: 0;
            color: #555;
            font-size: 14px;
        }
        .side-panel details {
            margin-bottom: 10px;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .side-panel summary {
            cursor: pointer;
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }
        .side-panel .params-grid {
            gap: 10px;
        }
        .side-panel .param-group label {
            font-size: 12px;
        }
        .side-panel .param-group input {
            padding: 5px;
            font-size: 13px;
        }
        .side-panel .param-group small {
            font-size: 10px;
        }
        .side-panel table {
            font-size: 11px;
        }
        .side-panel table input {
            font-size: 11px;
        }
        .side-panel-tab {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            z-index: 201;
            background: #555;
            color: white;
            border: none;
            border-radius: 6px 0 0 6px;
            width: 28px;
            padding: 12px 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            box-shadow: -2px 0 8px rgba(0,0,0,0.2);
            writing-mode: vertical-rl;
            text-orientation: mixed;
            letter-spacing: 1px;
            transition: right 0.3s ease, background 0.15s;
        }
        .side-panel-tab:hover {
            background: #333;
        }
        .side-panel-tab.open {
            right: 620px;
        }
        @media (max-width: 900px) {
            .side-panel-tab.open {
                right: 90vw;
            }
        }

        /* Key params section */
        .key-params-section {
            background: #FFFEF8;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 16px;
        }
        .key-params-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 14px 20px;
        }
        @media (max-width: 900px) {
            .key-params-grid { grid-template-columns: repeat(2, 1fr); }
        }
        .key-params-grid .param-group {
            display: flex;
            flex-direction: column;
        }
        .key-params-grid .param-group label {
            font-weight: 600;
            margin-bottom: 3px;
            color: #444;
            font-size: 13px;
        }
        .key-params-grid .param-group input {
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
        }
        .key-params-grid .param-group small {
            color: #888;
            font-size: 11px;
            margin-top: 3px;
            line-height: 1.3;
        }
        .key-params-section .run-row {
            display: flex;
            justify-content: flex-end;
            margin-top: 14px;
        }
        .key-params-section #runModel {
            padding: 10px 28px;
            font-size: 15px;
        }

        /* Feature toggles bar */
        .feature-toggles-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px 12px;
            background: #f8f8f8;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 12px;
        }
        .feature-toggles-bar label {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background: white;
            font-weight: 500;
            color: #555;
        }
        .feature-toggles-bar input[type="checkbox"] {
            width: 14px;
            height: 14px;
            margin: 0;
        }

        /* Chart toolbar (download) */
        .chart-toolbar {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
            z-index: 10;
            opacity: 0.3;
            transition: opacity 0.2s;
        }
        .chart-container:hover .chart-toolbar {
            opacity: 1;
        }
        .chart-toolbar button {
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chart-toolbar button:hover {
            background: rgba(0,0,0,0.8);
        }

        @media (max-width: 900px) {
            .side-panel {
                width: 90vw;
            }
        }
    </style>
</head>
<body>
    <h1>Scenario Growth Model</h1>

    <div class="data-section">
        <h2>Scenario Data</h2>
        <p>Edit the values below directly, or upload a CSV file to load a different scenario.</p>
        <div style="margin-bottom: 15px; padding: 10px; background: #f0f7ff; border-radius: 4px; border: 1px solid #cce5ff;">
            <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="regionMode" id="regionUS" value="us" checked style="margin-right: 6px; width: 16px; height: 16px;">
                    <span style="font-weight: 600; color: #004085;">US</span>
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="regionMode" id="regionChina" value="china" style="margin-right: 6px; width: 16px; height: 16px;">
                    <span style="font-weight: 600; color: #004085;">China</span>
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="regionMode" id="regionGlobal" value="global" style="margin-right: 6px; width: 16px; height: 16px;">
                    <span style="font-weight: 600; color: #004085;">Global</span>
                </label>
                <small style="color: #666;">(Country modes apply share fractions to global compute &amp; robots)</small>
            </div>
        </div>
        <div id="scenarioTableWrapper" style="overflow-x: auto; margin-bottom: 15px;">
            <!-- Table built by JS on page load -->
        </div>
        <div class="file-input-wrapper">
            <button id="resetDefaults" class="template-btn" title="Reset table to template defaults">Reset Defaults</button>
            <button id="downloadTemplate" class="template-btn">Download CSV</button>
            <label class="upload-label" style="display:inline-block; background:#6c757d; color:white; padding:8px 16px; border-radius:4px; cursor:pointer; font-size:14px;">
                Upload CSV
                <input type="file" id="fileInput" accept=".csv" style="display:none;">
            </label>
        </div>
        <div id="status" class="status hidden"></div>
    </div>

    <button class="side-panel-tab" id="sidePanelToggle" title="Advanced Parameters">Advanced Parameters &#x25C0;</button>

    <div class="app-layout">
        <div class="main-content">
            <!-- Key parameters (grid with descriptions) -->
            <div class="key-params-section">
                <div class="key-params-grid">
                    <div class="param-group">
                        <label for="eps">&epsilon; (cognitive vs physical)</label>
                        <input type="number" id="eps" value="0.70" step="0.01" min="0.01">
                        <small>Elasticity of substitution between cognitive and physical labor composites</small>
                    </div>
                    <div class="param-group">
                        <label for="sig_c">&sigma;<sub>c</sub> (human vs AI)</label>
                        <input type="number" id="sig_c" value="0.80" step="0.01" min="0.01">
                        <small>Elasticity of substitution between human cognitive workers and AI</small>
                    </div>
                    <div class="param-group">
                        <label for="sig_p">&sigma;<sub>p</sub> (human vs robot)</label>
                        <input type="number" id="sig_p" value="0.60" step="0.01" min="0.01">
                        <small>Elasticity of substitution between human physical workers and robots</small>
                    </div>
                    <div class="param-group">
                        <label for="alpha">&alpha; (capital share)</label>
                        <input type="number" id="alpha" value="0.36" step="0.01" min="0" max="1">
                        <small>Capital's share in the CES production function</small>
                    </div>
                    <div class="param-group">
                        <label for="sigma_K">&sigma;<sub>K</sub> (capital-labor)</label>
                        <input type="number" id="sigma_K" value="1.5" step="0.1" min="0.01" max="10">
                        <small>Elasticity of substitution between capital and labor composites</small>
                    </div>
                    <div class="param-group">
                        <label for="theta">&theta; (cognitive weight)</label>
                        <input type="number" id="theta" value="0.68" step="0.01" min="0" max="1">
                        <small>Weight on cognitive labor in the labor composite</small>
                    </div>
                    <div class="param-group">
                        <label for="base_Y">Y<sub>0</sub> (base GDP)</label>
                        <input type="text" id="base_Y" value="30.6T">
                        <small>Initial gross world product (use K, M, B, T suffixes)</small>
                    </div>
                    <div class="param-group">
                        <label for="base_L">L<sub>0</sub> (base labor force)</label>
                        <input type="text" id="base_L" value="168.6M">
                        <small>Initial labor force size (use K, M, B suffixes)</small>
                    </div>
                    <div class="param-group">
                        <label for="base_WAP">WAP<sub>0</sub> (working-age pop.)</label>
                        <input type="text" id="base_WAP" value="270.7M">
                        <small>Initial working-age population (use K, M, B suffixes)</small>
                    </div>
                </div>
                <div class="run-row">
                    <button id="runModel">Run Model</button>
                </div>
            </div>

            <!-- Charts grid -->
            <div class="charts-section">
                <!-- 1. Output -->
                <div class="chart-container">
                    <div class="chart-toolbar">
                        <button class="chart-download-btn" title="Download PNG" data-chart="outputChart">&#x2B07;</button>
                    </div>
                    <h3>Output: Forecast vs Model Prediction</h3>
                    <canvas id="outputChart"></canvas>
                </div>
                <!-- 2. GWP Breakdown -->
                <div class="chart-container" id="gwpBreakdownContainer" style="display: none;">
                    <div class="chart-toolbar">
                        <button class="chart-download-btn" title="Download PNG" data-chart="gwpBreakdownChart">&#x2B07;</button>
                    </div>
                    <h3>GWP Breakdown by Region</h3>
                    <canvas id="gwpBreakdownChart"></canvas>
                </div>
                <!-- 3. Factor Income Shares -->
                <div class="chart-container">
                    <div class="chart-toolbar">
                        <button class="chart-download-btn" title="Download PNG" data-chart="factorIncomeChart">&#x2B07;</button>
                    </div>
                    <h3 id="factorIncomeTitle">Factor Income Shares of GWP</h3>
                    <canvas id="factorIncomeChart"></canvas>
                </div>
                <!-- 4. Wages -->
                <div class="chart-container">
                    <div class="chart-toolbar">
                        <button class="chart-download-btn" title="Download PNG" data-chart="wagesChart">&#x2B07;</button>
                    </div>
                    <h3>Wages per Human Equivalent Worker</h3>
                    <canvas id="wagesChart"></canvas>
                </div>
                <!-- 5. Automated Task Shares -->
                <div class="chart-container">
                    <div class="chart-toolbar">
                        <button class="chart-download-btn" title="Download PNG" data-chart="muChart">&#x2B07;</button>
                    </div>
                    <h3>Automated Task Shares (1-&mu; terms)</h3>
                    <canvas id="muChart"></canvas>
                </div>
                <!-- 6. Labor Force and WAP -->
                <div class="chart-container">
                    <div class="chart-toolbar">
                        <button class="chart-download-btn" title="Download PNG" data-chart="laborChart">&#x2B07;</button>
                    </div>
                    <h3>Labor Force and Working Age Population</h3>
                    <canvas id="laborChart"></canvas>
                </div>
                <!-- 7. Human Labor Allocation -->
                <div class="chart-container">
                    <div class="chart-toolbar">
                        <button class="chart-download-btn" title="Download PNG" data-chart="ellChart">&#x2B07;</button>
                    </div>
                    <h3>Human Labor Allocation</h3>
                    <canvas id="ellChart"></canvas>
                </div>
                <!-- 8. Labor Productivity -->
                <div class="chart-container">
                    <div class="chart-toolbar">
                        <button class="chart-download-btn" title="Download PNG" data-chart="laborProductivityChart">&#x2B07;</button>
                    </div>
                    <h3>Labor Productivity</h3>
                    <canvas id="laborProductivityChart"></canvas>
                </div>
                <!-- 9. Rental Costs -->
                <div class="chart-container">
                    <div class="chart-toolbar">
                        <button class="chart-download-btn" title="Download PNG" data-chart="rentalCostChart">&#x2B07;</button>
                    </div>
                    <h3>Rental Costs over Time</h3>
                    <canvas id="rentalCostChart"></canvas>
                </div>
                <!-- 10. Capital Allocation -->
                <div class="chart-container">
                    <div class="chart-toolbar">
                        <button class="chart-download-btn" title="Download PNG" data-chart="capitalChart">&#x2B07;</button>
                    </div>
                    <h3>Productive Capital Allocation Shares</h3>
                    <canvas id="capitalChart"></canvas>
                </div>
                <!-- 11. Returns to Capital -->
                <div class="chart-container">
                    <div class="chart-toolbar">
                        <button class="chart-download-btn" title="Download PNG" data-chart="interestChart">&#x2B07;</button>
                    </div>
                    <h3>Returns to Productive Capital over Time</h3>
                    <canvas id="interestChart"></canvas>
                </div>
                <!-- 12. Capital Efficiency -->
                <div class="chart-container">
                    <div class="chart-toolbar">
                        <button class="chart-download-btn" title="Download PNG" data-chart="techChart">&#x2B07;</button>
                    </div>
                    <h3>(Implied) Capital Efficiency</h3>
                    <canvas id="techChart"></canvas>
                </div>
                <!-- 13. Land Rents (conditional) -->
                <div class="chart-container" id="landRentContainer" style="display: none;">
                    <div class="chart-toolbar">
                        <button class="chart-download-btn" title="Download PNG" data-chart="landRentChart">&#x2B07;</button>
                    </div>
                    <h3>Land Rent per Hectare ($/ha/year)</h3>
                    <canvas id="landRentChart"></canvas>
                </div>
                <!-- 14. Land Use (conditional) -->
                <div class="chart-container" id="landUseShareContainer" style="display: none;">
                    <div class="chart-toolbar">
                        <button class="chart-download-btn" title="Download PNG" data-chart="landUseShareChart">&#x2B07;</button>
                    </div>
                    <h3>Physical Land Use Shares by Category</h3>
                    <canvas id="landUseShareChart"></canvas>
                </div>
                <!-- 15. Consumer Budget (conditional) -->
                <div class="chart-container" id="consumerBudgetContainer" style="display: none;">
                    <div class="chart-toolbar">
                        <button class="chart-download-btn" title="Download PNG" data-chart="consumerBudgetChart">&#x2B07;</button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 5px;">
                        <h3 style="margin: 0;">Example Consumer Budget</h3>
                        <select id="consumerBudgetPctSelect" style="padding: 4px 8px; font-size: 14px;">
                            <option value="50" selected>Median (50th)</option>
                            <option value="10">10th Percentile</option>
                            <option value="90">90th Percentile</option>
                            <option value="99.5">99.5th Percentile</option>
                        </select>
                    </div>
                    <details style="margin-bottom: 8px; font-size: 13px;">
                        <summary style="cursor: pointer; color: #555;">Example budget allocation</summary>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 6px; padding: 6px; background: #f8f7f2; border-radius: 4px;">
                            <label style="display: flex; align-items: center; gap: 4px;">
                                Land share: <input type="number" id="cb_land_share" value="0.3" step="0.05" min="0" max="1" style="width: 55px; font-size: 13px;">
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px;">
                                AI vs Robot: <input type="number" id="cb_ai_share" value="0.5" step="0.05" min="0" max="1" style="width: 55px; font-size: 13px;">
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px;">
                                Urban vs Rural: <input type="number" id="cb_urban_share" value="0.5" step="0.05" min="0" max="1" style="width: 55px; font-size: 13px;">
                            </label>
                        </div>
                        <div style="color: #888; font-size: 11px; margin-top: 3px;">Illustrative splits for one person's budget. Does not affect model prices.</div>
                    </details>
                    <canvas id="consumerBudgetChart"></canvas>
                </div>
                <!-- 16. Household Expenditure Split (conditional) -->
                <div class="chart-container" id="landIncomeShareContainer" style="display: none;">
                    <div class="chart-toolbar">
                        <button class="chart-download-btn" title="Download PNG" data-chart="landIncomeShareChart">&#x2B07;</button>
                    </div>
                    <h3>Household Expenditure Split</h3>
                    <canvas id="landIncomeShareChart"></canvas>
                </div>
                <!-- 17. Wage Income (conditional) -->
                <div class="chart-container" id="wageIncomeChartContainer" style="display: none;">
                    <div class="chart-toolbar">
                        <button class="chart-download-btn" title="Download PNG" data-chart="wageIncomeChart">&#x2B07;</button>
                    </div>
                    <h3>Wage Income per Working-Age Person</h3>
                    <canvas id="wageIncomeChart"></canvas>
                </div>
                <!-- 18. UBI Transfers (conditional) -->
                <div class="chart-container" id="ubiTransferChartContainer" style="display: none;">
                    <div class="chart-toolbar">
                        <button class="chart-download-btn" title="Download PNG" data-chart="ubiTransferChart">&#x2B07;</button>
                    </div>
                    <h3>UBI Transfers per Working-Age Person</h3>
                    <canvas id="ubiTransferChart"></canvas>
                </div>
                <!-- 19. Income Distribution (conditional) -->
                <div class="chart-container" id="incomeDistContainer" style="display: none;">
                    <div class="chart-toolbar">
                        <button class="chart-download-btn" title="Download PNG" data-chart="incomeDistChart">&#x2B07;</button>
                    </div>
                    <h3>Income Distribution (per Working-Age Person)</h3>
                    <canvas id="incomeDistChart"></canvas>
                </div>
                <!-- 20. Income Composition (conditional) -->
                <div class="chart-container" id="incomeCompContainer" style="display: none;">
                    <div class="chart-toolbar">
                        <button class="chart-download-btn" title="Download PNG" data-chart="incomeCompChart">&#x2B07;</button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 5px;">
                        <h3 style="margin: 0;">Income Composition by Percentile</h3>
                        <select id="incomeCompYearSelect" style="padding: 4px 8px; font-size: 14px;"></select>
                    </div>
                    <canvas id="incomeCompChart"></canvas>
                </div>
                <!-- 21. Net Worth Distribution (conditional) -->
                <div class="chart-container" id="netWorthContainer" style="display: none;">
                    <div class="chart-toolbar">
                        <button class="chart-download-btn" title="Download PNG" data-chart="netWorthChart">&#x2B07;</button>
                    </div>
                    <h3>Net Worth Distribution (per Working-Age Person)</h3>
                    <canvas id="netWorthChart"></canvas>
                </div>
                <!-- 22. Gini (conditional) -->
                <div class="chart-container" id="giniContainer" style="display: none;">
                    <div class="chart-toolbar">
                        <button class="chart-download-btn" title="Download PNG" data-chart="giniChart">&#x2B07;</button>
                    </div>
                    <h3>Gini Coefficients Over Time</h3>
                    <canvas id="giniChart"></canvas>
                </div>
            </div>

            <div id="resultsTable" class="results-table hidden">
                <h3>Detailed Results</h3>
                <div id="tableContainer"></div>
            </div>
        </div>

        <!-- Side Panel: Advanced Parameters -->
        <div class="side-panel collapsed" id="sidePanel">
            <h3>Advanced Parameters</h3>

            <details open>
                <summary>Model Features</summary>
                <div class="feature-toggles-bar" style="margin-top: 8px;">
                    <label><input type="checkbox" id="useLand" checked> Land</label>
                    <label><input type="checkbox" id="useTaxation" checked> Taxation</label>
                    <label><input type="checkbox" id="usePredictedOutput" checked> Predict Output</label>
                    <label><input type="checkbox" id="useIncomeDistribution" checked> Income Distribution</label>
                </div>
            </details>

            <details>
                <summary>Key Starting Values &amp; Assumptions</summary>
                <div style="margin-top: 10px; font-size: 12px; line-height: 1.5;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="border-bottom: 2px solid #ccc; text-align: left;">
                                <th style="padding: 3px 6px;">Category</th>
                                <th style="padding: 3px 6px;">Parameter</th>
                                <th style="padding: 3px 6px;">US</th>
                                <th style="padding: 3px 6px;">Global</th>
                                <th style="padding: 3px 6px;">Confidence</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 3px 6px;" colspan="5"><strong>Base-Year Macro (2025)</strong></td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 3px 6px;">GDP / Output</td>
                                <td style="padding: 3px 6px;">Y&#x2080;</td>
                                <td style="padding: 3px 6px;">$30.6T</td>
                                <td style="padding: 3px 6px;">$117T</td>
                                <td style="padding: 3px 6px; color: green;">High</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 3px 6px;">Productive Capital</td>
                                <td style="padding: 3px 6px;">K&#x2080;</td>
                                <td style="padding: 3px 6px;">$91.8T</td>
                                <td style="padding: 3px 6px;">$410T</td>
                                <td style="padding: 3px 6px; color: #b8860b;">Medium</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 3px 6px;">K/Y ratio</td>
                                <td style="padding: 3px 6px;">K&#x2080;/Y&#x2080;</td>
                                <td style="padding: 3px 6px;">3.0</td>
                                <td style="padding: 3px 6px;">~3.5</td>
                                <td style="padding: 3px 6px; color: #b8860b;">Medium</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 3px 6px;">Labor share</td>
                                <td style="padding: 3px 6px;">1-&#x3B1;-s_L</td>
                                <td style="padding: 3px 6px;">58.3%</td>
                                <td style="padding: 3px 6px;">52.3%</td>
                                <td style="padding: 3px 6px; color: #b8860b;">Medium</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 3px 6px;">Labor Force</td>
                                <td style="padding: 3px 6px;">L&#x2080;</td>
                                <td style="padding: 3px 6px;">168.6M</td>
                                <td style="padding: 3px 6px;">3.5B</td>
                                <td style="padding: 3px 6px; color: green;">High</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 3px 6px;" colspan="5"><strong>Substitution Elasticities</strong></td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 3px 6px;">Cog vs Physical</td>
                                <td style="padding: 3px 6px;">&#x3B5; = 0.70</td>
                                <td style="padding: 3px 6px;" colspan="2">Same</td>
                                <td style="padding: 3px 6px; color: red;">Low</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 3px 6px;">Human vs AI</td>
                                <td style="padding: 3px 6px;">&#x3C3;_c = 0.80</td>
                                <td style="padding: 3px 6px;" colspan="2">Same</td>
                                <td style="padding: 3px 6px; color: red;">Low</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 3px 6px;">Human vs Robot</td>
                                <td style="padding: 3px 6px;">&#x3C3;_p = 0.60</td>
                                <td style="padding: 3px 6px;" colspan="2">Same</td>
                                <td style="padding: 3px 6px; color: red;">Low</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 3px 6px;" colspan="5"><strong>Depreciation</strong></td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 3px 6px;">Productive capital</td>
                                <td style="padding: 3px 6px;">&#x3B4;_K = 5%</td>
                                <td style="padding: 3px 6px;" colspan="2">Same</td>
                                <td style="padding: 3px 6px; color: green;">High</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 3px 6px;">AI compute</td>
                                <td style="padding: 3px 6px;">&#x3B4;_C = 30%</td>
                                <td style="padding: 3px 6px;" colspan="2">Same</td>
                                <td style="padding: 3px 6px; color: #b8860b;">Medium</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 3px 6px;">Robot capital</td>
                                <td style="padding: 3px 6px;">&#x3B4;_R = 10%</td>
                                <td style="padding: 3px 6px;" colspan="2">Same</td>
                                <td style="padding: 3px 6px; color: #b8860b;">Medium</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </details>

            <details open>
                <summary>Other Elasticities</summary>
                <div class="params-grid" style="margin-top: 8px;">
                    <div class="param-group">
                        <label for="omega">&omega; (labor elasticity)</label>
                        <input type="number" id="omega" value="0.2" step="0.1" min="0">
                        <small>L_c/L_p = &kappa; &middot; (w_c/w_p)^&omega;</small>
                    </div>
                    <div class="param-group">
                        <label for="kappa">&kappa; (labor ratio scale)</label>
                        <input type="number" id="kappa" value="1.6" step="0.1" min="0.01">
                        <small>Scale factor in L_c/L_p</small>
                    </div>
                </div>
            </details>

            <details>
                <summary>Trusted Labor Sector</summary>
                <div class="params-grid" style="margin-top: 8px;">
                    <div class="param-group">
                        <label for="trust_start_year">Start Year</label>
                        <input type="number" id="trust_start_year" value="2029" step="1" min="2025" max="2060">
                        <small>Year when trusted labor sector begins</small>
                    </div>
                    <div class="param-group">
                        <label for="trust_num_workers">Initial Workers</label>
                        <input type="number" id="trust_num_workers" value="100000" step="5000" min="100">
                        <small>Number of trusted-sector workers at start year</small>
                    </div>
                    <div class="param-group">
                        <label for="trust_avg_wage">Avg Wage ($)</label>
                        <input type="number" id="trust_avg_wage" value="150000" step="10000" min="1000">
                        <small>Per-worker wage at start year</small>
                    </div>
                    <div class="param-group">
                        <label for="trust_sigma">&sigma;_trust (CES)</label>
                        <input type="number" id="trust_sigma" value="0.9" step="0.01" min="0.01" max="10">
                        <small>Substitutability with rest of economy</small>
                    </div>
                    <div class="param-group">
                        <label for="trust_C_2040">Efficiency (2040)</label>
                        <input type="number" id="trust_C_2040" value="2" step="0.1" min="0.1">
                        <small>Efficiency per worker by 2040</small>
                    </div>
                </div>
            </details>

            <details>
                <summary>Depreciation Rates</summary>
                <div class="params-grid" style="margin-top: 8px;">
                    <div class="param-group">
                        <label for="delta_K">&delta;_K (productive capital)</label>
                        <input type="number" id="delta_K" value="0.05" step="0.01" min="0" max="1">
                        <small>Depreciation of productive capital K_Y</small>
                    </div>
                    <div class="param-group">
                        <label for="delta_C">&delta;_C (AI capital)</label>
                        <input type="number" id="delta_C" value="0.30" step="0.01" min="0" max="1">
                        <small>Depreciation of K_C</small>
                    </div>
                    <div class="param-group">
                        <label for="delta_R">&delta;_R (robot capital)</label>
                        <input type="number" id="delta_R" value="0.10" step="0.01" min="0" max="1">
                        <small>Depreciation of K_R</small>
                    </div>
                </div>
            </details>

            <details id="capitalAccumParams">
                <summary>Capital Accumulation</summary>
                <div class="params-grid" style="margin-top: 8px;">
                    <div class="param-group">
                        <label for="savings_rate">s (savings rate)</label>
                        <input type="number" id="savings_rate" value="0.20" step="0.01" min="0" max="1">
                        <small>Fraction of output saved</small>
                    </div>
                    <div class="param-group">
                        <label for="initial_KY_ratio">K/Y ratio (base year)</label>
                        <input type="number" id="initial_KY_ratio" value="3.00" step="0.01" min="0.1">
                        <small>Capital-to-output ratio: K&#x2080; = (K/Y) &times; Y&#x2080;</small>
                    </div>
                </div>
            </details>

            <div id="landParams">
                <details>
                    <summary>Land Parameters</summary>
                    <div style="margin-top: 8px;">
                        <div class="params-grid">
                            <div class="param-group">
                                <label for="land_exp_share">Land Expenditure Share</label>
                                <input type="number" id="land_exp_share" value="0.068" step="0.001" min="0.001" max="0.5">
                                <small>Fraction of household spending on land (base year)</small>
                            </div>
                            <div class="param-group">
                                <label for="protect_wilderness">Wilderness Protection</label>
                                <input type="number" id="protect_wilderness" value="0.8" step="0.01" min="0" max="1">
                                <small>Fraction of wilderness protected after deregulation</small>
                            </div>
                            <div class="param-group">
                                <label for="land_dereg_year">Land Deregulation Year</label>
                                <input type="number" id="land_dereg_year" value="2032" step="1" min="2025" max="2100">
                                <small>Year wilderness begins to be released</small>
                            </div>
                            <div class="param-group">
                                <label for="land_dereg_ramp">Deregulation Ramp (years)</label>
                                <input type="number" id="land_dereg_ramp" value="7" step="1" min="0" max="100">
                                <small>Years to fully release wilderness (linear ramp)</small>
                            </div>
                            <div class="param-group">
                                <label for="protect_commercial">Commercial Protection</label>
                                <input type="number" id="protect_commercial" value="1" step="0.01" min="0" max="1">
                                <small>Fraction of commercial land that cannot be converted</small>
                            </div>
                        </div>
                        <details style="margin-top: 8px;">
                            <summary style="font-size: 12px;">Land Category Elasticities</summary>
                            <div style="margin-top: 8px;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid #ccc;">
                                            <th style="text-align: left; padding: 3px 4px;">Category</th>
                                            <th style="padding: 3px 4px;">&beta; (income)</th>
                                            <th style="padding: 3px 4px;">&eta;<sup>D</sup> (demand)</th>
                                            <th style="padding: 3px 4px;">&eta;<sup>S</sup> (supply)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td style="padding: 3px 4px;">Urban</td>
                                            <td style="padding: 3px 4px;"><input type="number" id="beta_urban" value="1.1" step="0.01" min="0.01" max="3" style="width: 55px;"></td>
                                            <td style="padding: 3px 4px;"><input type="number" id="eta_D_urban" value="1" step="0.01" min="0.01" max="5" style="width: 55px;"></td>
                                            <td style="padding: 3px 4px;"><input type="number" id="eta_S_urban" value="0.5" step="0.01" min="0.01" max="5" style="width: 55px;"></td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 3px 4px;">Rural</td>
                                            <td style="padding: 3px 4px;"><input type="number" id="beta_rural" value="1.1" step="0.01" min="0.01" max="3" style="width: 55px;"></td>
                                            <td style="padding: 3px 4px;"><input type="number" id="eta_D_rural" value="1" step="0.01" min="0.01" max="5" style="width: 55px;"></td>
                                            <td style="padding: 3px 4px;"><input type="number" id="eta_S_rural" value="0.8" step="0.01" min="0.01" max="5" style="width: 55px;"></td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 3px 4px;">Agricultural</td>
                                            <td style="padding: 3px 4px;"><input type="number" id="beta_agricultural" value="0.1" step="0.01" min="0.01" max="3" style="width: 55px;"></td>
                                            <td style="padding: 3px 4px;"><input type="number" id="eta_D_agricultural" value="0.4" step="0.01" min="0.01" max="5" style="width: 55px;"></td>
                                            <td style="padding: 3px 4px;"><input type="number" id="eta_S_agricultural" value="0.6" step="0.01" min="0.01" max="5" style="width: 55px;"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </details>
                        <div class="params-grid" style="margin-top: 8px;">
                            <div class="param-group">
                                <label for="land_cap_rate">Cap Rate (%)</label>
                                <input type="number" id="land_cap_rate" value="4.5" step="0.1" min="0.1" max="20">
                                <small>Capitalization rate for land valuation</small>
                            </div>
                        </div>
                    </div>
                </details>
            </div>

            <div id="incomeDistParams">
                <details>
                    <summary>Income Distribution</summary>
                    <div style="margin-top: 8px;">
                        <details>
                            <summary style="font-size: 12px;">Ownership Distribution</summary>
                            <div style="margin-top: 8px;">
                                <table style="width:100%; border-collapse: collapse; font-size: 11px;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid #ccc;">
                                            <th style="text-align:left; padding: 3px 4px;">Asset</th>
                                            <th style="padding: 3px 3px;">p1</th>
                                            <th style="padding: 3px 3px;">p25</th>
                                            <th style="padding: 3px 3px;">p50</th>
                                            <th style="padding: 3px 3px;">p75</th>
                                            <th style="padding: 3px 3px;">p90</th>
                                            <th style="padding: 3px 3px;">p99</th>
                                            <th style="padding: 3px 3px;">p99.9</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td style="padding: 3px 4px; font-weight: 600;">Wages</td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_wage_1" value="0.00006" step="0.00001" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_wage_25" value="0.034" step="0.005" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_wage_50" value="0.1146" step="0.005" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_wage_75" value="0.3011" step="0.01" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_wage_90" value="0.5064" step="0.01" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_wage_99" value="0.7756" step="0.01" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_wage_999" value="0.8863" step="0.01" min="0" max="1" style="width:55px;"></td>
                                        </tr>
                                        <tr style="background: #eee;">
                                            <td style="padding: 3px 4px; font-weight: 600;">Capital</td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_capital_1" value="0.0" step="0.001" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_capital_25" value="0.0" step="0.001" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_capital_50" value="0.025" step="0.005" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_capital_75" value="0.10" step="0.01" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_capital_90" value="0.326" step="0.01" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_capital_99" value="0.69" step="0.01" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_capital_999" value="0.861" step="0.01" min="0" max="1" style="width:55px;"></td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 3px 4px; font-weight: 600;">AI</td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_ai_1" value="0.0" step="0.001" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_ai_25" value="0.0005" step="0.0001" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_ai_50" value="0.003" step="0.001" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_ai_75" value="0.015" step="0.005" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_ai_90" value="0.05" step="0.01" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_ai_99" value="0.25" step="0.01" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_ai_999" value="0.50" step="0.01" min="0" max="1" style="width:55px;"></td>
                                        </tr>
                                        <tr style="background: #eee;">
                                            <td style="padding: 3px 4px; font-weight: 600;">Robots</td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_robot_1" value="0.0" step="0.001" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_robot_25" value="0.001" step="0.0005" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_robot_50" value="0.005" step="0.001" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_robot_75" value="0.025" step="0.005" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_robot_90" value="0.08" step="0.01" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_robot_99" value="0.35" step="0.01" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_robot_999" value="0.60" step="0.01" min="0" max="1" style="width:55px;"></td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 3px 4px; font-weight: 600;">Land</td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_land_1" value="0.0" step="0.001" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_land_25" value="0.015" step="0.005" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_land_50" value="0.098" step="0.01" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_land_75" value="0.30" step="0.01" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_land_90" value="0.559" step="0.01" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_land_99" value="0.865" step="0.01" min="0" max="1" style="width:55px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="cdf_land_999" value="0.96" step="0.01" min="0" max="1" style="width:55px;"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </details>
                        <details style="margin-top: 8px;">
                            <summary style="font-size: 12px;">Income Distribution Curves</summary>
                            <div style="margin-top: 8px;">
                                <table style="width:100%; border-collapse: collapse; font-size: 11px;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid #ccc;">
                                            <th style="text-align:left; padding: 3px 4px;">Source</th>
                                            <th style="padding: 3px 3px;">p5</th>
                                            <th style="padding: 3px 3px;">p10</th>
                                            <th style="padding: 3px 3px;">p25</th>
                                            <th style="padding: 3px 3px;">p50</th>
                                            <th style="padding: 3px 3px;">p75</th>
                                            <th style="padding: 3px 3px;">p90</th>
                                            <th style="padding: 3px 3px;">p95</th>
                                            <th style="padding: 3px 3px;">p99</th>
                                            <th style="padding: 3px 3px;">p99.9</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td style="padding: 3px 4px; font-weight: 600;">Wages</td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_wage_5" value="0.04" step="0.01" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_wage_10" value="0.10" step="0.01" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_wage_25" value="0.28" step="0.01" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_wage_50" value="0.62" step="0.01" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_wage_75" value="1.20" step="0.01" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_wage_90" value="2.10" step="0.1" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_wage_95" value="3.30" step="0.1" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_wage_99" value="8.50" step="0.5" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_wage_999" value="40.0" step="1" min="0" style="width:50px;"></td>
                                        </tr>
                                        <tr style="background: #eee;">
                                            <td style="padding: 3px 4px; font-weight: 600;">Capital</td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_capital_5" value="0.0" step="0.01" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_capital_10" value="0.0" step="0.01" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_capital_25" value="0.02" step="0.01" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_capital_50" value="0.10" step="0.01" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_capital_75" value="0.45" step="0.05" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_capital_90" value="1.80" step="0.1" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_capital_95" value="4.00" step="0.5" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_capital_99" value="12.0" step="1" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_capital_999" value="80.0" step="5" min="0" style="width:50px;"></td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 3px 4px; font-weight: 600;">AI</td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_ai_5" value="0.0" step="0.01" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_ai_10" value="0.0" step="0.01" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_ai_25" value="0.005" step="0.001" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_ai_50" value="0.02" step="0.005" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_ai_75" value="0.10" step="0.01" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_ai_90" value="0.50" step="0.1" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_ai_95" value="2.50" step="0.5" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_ai_99" value="10.0" step="1" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_ai_999" value="60.0" step="5" min="0" style="width:50px;"></td>
                                        </tr>
                                        <tr style="background: #eee;">
                                            <td style="padding: 3px 4px; font-weight: 600;">Robots</td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_robot_5" value="0.0" step="0.01" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_robot_10" value="0.0" step="0.01" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_robot_25" value="0.005" step="0.001" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_robot_50" value="0.02" step="0.005" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_robot_75" value="0.10" step="0.01" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_robot_90" value="0.50" step="0.1" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_robot_95" value="2.50" step="0.5" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_robot_99" value="10.0" step="1" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_robot_999" value="60.0" step="5" min="0" style="width:50px;"></td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 3px 4px; font-weight: 600;">Land</td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_land_5" value="0.02" step="0.01" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_land_10" value="0.06" step="0.01" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_land_25" value="0.20" step="0.01" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_land_50" value="0.55" step="0.05" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_land_75" value="1.10" step="0.1" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_land_90" value="2.00" step="0.1" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_land_95" value="3.50" step="0.5" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_land_99" value="8.00" step="1" min="0" style="width:50px;"></td>
                                            <td style="padding: 3px 2px;"><input type="number" id="mult_land_999" value="30.0" step="5" min="0" style="width:50px;"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </details>
                        <div class="params-grid" style="margin-top: 8px;">
                            <div class="param-group">
                                <label for="lfp_target">LFP target</label>
                                <input type="number" id="lfp_target" value="0.62" step="0.01" min="0.01" max="0.99">
                                <small>Base-year labor force participation rate</small>
                            </div>
                            <div class="param-group">
                                <label for="logistic_s">Logistic s</label>
                                <input type="number" id="logistic_s" value="0.7" step="0.1" min="0.1">
                                <small>Participation drop steepness</small>
                            </div>
                            <div class="param-group">
                                <label for="k_ubi">UBI dampener (k)</label>
                                <input type="number" id="k_ubi" value="1.13" step="0.01" min="0">
                                <small>LFP &times; exp(-k &middot; UBI/wage)</small>
                            </div>
                            <div class="param-group">
                                <label for="labor_damp">Labor damping</label>
                                <input type="number" id="labor_damp" value="0.5" step="0.05" min="0.05" max="1.0">
                                <small>Blend factor for convergence</small>
                            </div>
                        </div>
                        <div id="lfpParams"></div>
                    </div>
                </details>
            </div>

            <div id="taxParamsInner">
                <details>
                    <summary>Taxation &amp; UBI</summary>
                    <div class="params-grid" style="margin-top: 8px;">
                        <div class="param-group">
                            <label for="ubi_start_year">Tax + UBI Start Year</label>
                            <input type="number" id="ubi_start_year" value="2033" step="1" min="2025" max="2060">
                            <small>Year when capital taxes &amp; UBI begin</small>
                        </div>
                        <div class="param-group">
                            <label for="tau_k">&tau;_k (capital tax)</label>
                            <input type="number" id="tau_k" value="0" step="0.01" min="0" max="0.99">
                            <small>Tax on productive capital income</small>
                        </div>
                        <div class="param-group">
                            <label for="tau_AI">&tau;_AI (AI tax)</label>
                            <input type="number" id="tau_AI" value="0.10" step="0.01" min="0" max="0.99">
                            <small>Tax on AI service revenue</small>
                        </div>
                        <div class="param-group">
                            <label for="tau_R">&tau;_R (robot tax)</label>
                            <input type="number" id="tau_R" value="0.10" step="0.01" min="0" max="0.99">
                            <small>Tax on robot service revenue</small>
                        </div>
                        <div class="param-group">
                            <label for="ubi_share_us">UBI Share (US)</label>
                            <input type="number" id="ubi_share_us" value="0.50" step="0.01" min="0" max="1">
                            <small>Fraction of tax revenue to US UBI</small>
                        </div>
                        <div class="param-group">
                            <label for="ubi_share_world">UBI Share (World)</label>
                            <input type="number" id="ubi_share_world" value="0.30" step="0.01" min="0" max="1">
                            <small>Fraction of tax revenue to world ex-China UBI</small>
                        </div>
                    </div>
                </details>
            </div>

            <div class="params-grid hidden" id="psiParams" style="padding: 8px;">
                <div class="param-group">
                    <label for="psi">&psi; (labor supply elasticity)</label>
                    <input type="number" id="psi" value="0.5" step="0.1" min="0.01">
                    <small>Used when Income Distribution is off</small>
                </div>
            </div>

            <!-- Hidden tax params placeholder for backward compat -->
            <div id="taxParams"></div>

            <div style="position: sticky; bottom: 0; padding: 12px 0 4px; background: #FFFEF8; border-top: 1px solid #ddd; margin-top: 12px; text-align: center;">
                <button id="runModelSidePanel" style="width: 100%; padding: 10px 16px; font-size: 14px; font-weight: 600; cursor: pointer; background: #555; color: white; border: none; border-radius: 6px;">Run Model</button>
            </div>
        </div>
    </div>

    <script>
    // ========================================
    // Template Data for Editable Table
    // ========================================

    const TEMPLATE_YEARS = [2025,2026,2027,2028,2029,2030,2031,2032,2033,2034,2035,2036,2037,2038,2039,2040];

    // Editable rows shown in the table (6 core + 2 conditional share rows)
    const TEMPLATE_ROWS = [
        {
            label: "Human Equiv. AI Cognitive Workforce",
            values: null,
            derived: true, bold: true,
            compute: function(rows) {
                var a = rows["AI Copies"], b = rows["Human-equivs per AI Copy"];
                if (!a || !b) return null;
                return a.map(function(v, i) { return v * b[i]; });
            }
        },
        {
            label: "Human Equiv. Robotic Physical Workforce",
            values: null,
            derived: true, bold: true,
            compute: function(rows) {
                var a = rows["Robots"], b = rows["Human-equivs per Robot"];
                if (!a || !b) return null;
                return a.map(function(v, i) { return v * b[i]; });
            }
        },
        {
            label: "AI Copies",
            values: ["51.9M","79.4M","114.6M","161.6M","171.1M","212.6M","313.3M","747.9M","2.1B","6.8B","25.9B","89.4B","180.7B","361.4B","719.6B","1.4T"]
        },
        {
            label: "Human-equivs per AI Copy",
            values: ["0.005","0.01","0.04","0.13","0.38","1.13","3.36","10.0","29.78","88.69","264.13","157.64","94.08","56.15","33.51","20"]
        },
        {
            label: "AI Copies per H100e",
            values: ["20","12.5","7.143","4.348","2.564","1.538","0.9259","0.5556","0.3333","0.2","0.1199","0.07189","0.04308","0.02583","0.01548","0.009283"]
        },
        {
            label: "Robots",
            values: ["2.0K","6.0K","18.0K","54.0K","162.0K","648.0K","2.6M","13.0M","64.8M","324.0M","972.0M","4.9B","24.3B","121.5B","607.5B","3.0T"]
        },
        {
            label: "Human-equivs per Robot",
            values: ["0.002","0.005","0.01","0.04","0.12","0.37","1.11","3.33","10","30","90","99","108.9","119.79","131.769","144.9459"]
        },
        {
            label: "Cognitive Automation Frontier",
            bold: true,
            values: ["2%","3%","5%","17%","38%","52%","65%","78%","90%","96%","99%","100%","100%","100%","100%","100%"]
        },
        {
            label: "Physical Automation Frontier",
            bold: true,
            values: ["2%","2%","2%","2%","5%","17%","38%","52%","65%","78%","90%","96%","99%","100%","100%","100%"]
        },
    ];

    // Share rows for each country mode
    const US_SHARE_ROWS = [
        {
            label: "US Share of Compute",
            values: ["70%","70%","70%","70%","70%","70%","70%","70%","70%","70%","70%","70%","70%","70%","70%","70%"]
        },
        {
            label: "US Share of Robots",
            values: ["15%","15%","15%","15%","15%","15%","15%","15%","15%","15%","15%","15%","15%","15%","15%","15%"]
        }
    ];

    const CHINA_SHARE_ROWS = [
        {
            label: "China Share of Compute",
            values: ["15%","15%","15%","15%","15%","15%","15%","15%","15%","15%","15%","15%","15%","15%","15%","15%"]
        },
        {
            label: "China Share of Robots",
            values: ["70%","70%","70%","70%","70%","70%","70%","70%","70%","70%","70%","70%","70%","70%","70%","70%"]
        }
    ];

    // All share rows combined (always in table; visibility toggled by mode)
    const ALL_SHARE_ROWS = US_SHARE_ROWS.concat(CHINA_SHARE_ROWS);

    // Background defaults for US economy (fallback if CSV not loaded)
    var BACKGROUND_DEFAULTS_US = {
        "Human Working Age Population": ["270.7M","273.4M","276.1M","278.9M","281.7M","284.5M","287.3M","290.2M","293.1M","296.0M","299.0M","302.0M","305.0M","308.1M","311.1M","314.3M"],
        "Human Labor Force": ["168.6M","168.4M","168.0M","167.4M","166.5M","164.0M","159.0M","151.0M","140.0M","126.0M","108.0M","88.0M","66.0M","47.0M","37.0M","33.3M"],
        "Output": ["30.6T","31.2T","32T","33T","33.5T","34.5T","36.5T","39.5T","45.5T","63T","120T","205T","373T","710T","1375T","2710T"],
        "Capital": ["91.8T","93T","94T","95T","96T","97T","98T","99T","101T","104T","110T","125T","154T","210T","320T","538T"]
    };

    // Background defaults for Global economy (fallback if CSV not loaded)
    var BACKGROUND_DEFAULTS_GLOBAL = {
        "Human Working Age Population": ["5.10B","5.12B","5.15B","5.18B","5.21B","5.24B","5.28B","5.32B","5.36B","5.40B","5.44B","5.49B","5.53B","5.58B","5.63B","5.68B"],
        "Human Labor Force": ["3.50B","3.50B","3.49B","3.47B","3.44B","3.38B","3.30B","3.18B","3.02B","2.80B","2.50B","2.15B","1.75B","1.30B","0.95B","0.70B"],
        "Output": ["117T","120T","124T","128T","132T","137T","144T","155T","179T","249T","475T","811T","1477T","2804T","5438T","10715T"],
        "Capital": ["410T","414T","418T","422T","427T","432T","438T","444T","452T","465T","490T","556T","685T","932T","1420T","2384T"]
    };

    // Background defaults for China economy (IMF, UN WPP, PWT sources)
    var BACKGROUND_DEFAULTS_CHINA = {
        "Human Working Age Population": ["983M","977M","972M","966M","961M","955M","948M","941M","934M","927M","920M","913M","906M","899M","892M","885M"],
        "Human Labor Force": ["637M","635M","633M","631M","629M","620M","600M","570M","525M","470M","400M","320M","235M","165M","133M","123M"],
        "Output": ["20.7T","21.3T","22T","22.8T","23.5T","24.5T","26T","28T","32T","44T","84T","144T","262T","497T","963T","1897T"],
        "Capital": ["70T","71T","72T","73T","74T","75T","76T","77T","78.5T","81T","85T","97T","119T","163T","248T","417T"]
    };

    // Compute RoW defaults = Global - US - China
    function computeRoWDefaults() {
        var row = {};
        var keys = ["Human Working Age Population", "Human Labor Force", "Output", "Capital"];
        keys.forEach(function(key) {
            var g = BACKGROUND_DEFAULTS_GLOBAL[key].map(function(v) { return parseCell(v); });
            var u = BACKGROUND_DEFAULTS_US[key].map(function(v) { return parseCell(v); });
            var c = BACKGROUND_DEFAULTS_CHINA[key].map(function(v) { return parseCell(v); });
            row[key] = g.map(function(v, i) { return Math.max(0, v - u[i] - c[i]); });
        });
        return row;
    }

    function getRegionMode() {
        var radios = document.querySelectorAll('input[name="regionMode"]');
        for (var i = 0; i < radios.length; i++) {
            if (radios[i].checked) return radios[i].value;
        }
        return 'global';
    }

    function isUSMode() {
        return getRegionMode() === 'us';
    }

    function isChinaMode() {
        return getRegionMode() === 'china';
    }

    function isCountryMode() {
        return getRegionMode() !== 'global';
    }


    // Check if land mode is enabled
    function isLandMode() {
        return document.getElementById('useLand').checked;
    }

    // Check if endogenous labor supply is enabled


    // Check if taxation is enabled
    function isTaxationMode() {
        return document.getElementById('useTaxation').checked;
    }

    // Check if predicted output mode is enabled
    function isPredictedOutputMode() {
        return document.getElementById('usePredictedOutput').checked;
    }

    // Check if income distribution mode is enabled
    function isIncomeDistributionMode() {
        return document.getElementById('useIncomeDistribution').checked;
    }

    // Get parameters from inputs
    function getParams() {
        const params = {
            alpha: parseFloat(document.getElementById('alpha').value),
            eps: parseFloat(document.getElementById('eps').value),
            sig_c: parseFloat(document.getElementById('sig_c').value),
            sig_p: parseFloat(document.getElementById('sig_p').value),
            kappa: parseFloat(document.getElementById('kappa').value),
            omega: parseFloat(document.getElementById('omega').value),
            theta: parseFloat(document.getElementById('theta').value),
            psi: parseFloat(document.getElementById('psi').value),
            // Depreciation rates
            delta_K: parseFloat(document.getElementById('delta_K').value),
            delta_C: parseFloat(document.getElementById('delta_C').value),
            delta_R: parseFloat(document.getElementById('delta_R').value),
            sigma_K: parseFloat(document.getElementById('sigma_K').value)
        };

        // Trusted labor params (always on)
        params.trust_start_year = parseInt(document.getElementById('trust_start_year').value);
        params.trust_num_workers = parseFloat(document.getElementById('trust_num_workers').value);
        params.trust_avg_wage = parseFloat(document.getElementById('trust_avg_wage').value);
        params.trust_initial_value = params.trust_num_workers * params.trust_avg_wage;
        params.trust_sigma = parseFloat(document.getElementById('trust_sigma').value);
        params.trust_C_2040 = parseFloat(document.getElementById('trust_C_2040').value);

        if (isLandMode()) {
            params.land_exp_share = parseFloat(document.getElementById('land_exp_share').value);
            params.protect_wilderness = parseFloat(document.getElementById('protect_wilderness').value);
            params.land_dereg_year = parseInt(document.getElementById('land_dereg_year').value);
            params.land_dereg_ramp = parseInt(document.getElementById('land_dereg_ramp').value);
            params.protect_commercial = parseFloat(document.getElementById('protect_commercial').value);
            params.beta = {};
            params.eta_D = {};
            params.eta_S = {};
            for (var c = 0; c < LAND_ENDOGENOUS_CATEGORIES.length; c++) {
                var cat = LAND_ENDOGENOUS_CATEGORIES[c];
                params.beta[cat] = parseFloat(document.getElementById('beta_' + cat).value);
                params.eta_D[cat] = parseFloat(document.getElementById('eta_D_' + cat).value);
                params.eta_S[cat] = parseFloat(document.getElementById('eta_S_' + cat).value);
            }
            params.land_cap_rate = parseFloat(document.getElementById('land_cap_rate').value) / 100 || 0.04;
        }

        if (isTaxationMode()) {
            params.tau_k = parseFloat(document.getElementById('tau_k').value);
            params.tau_AI = parseFloat(document.getElementById('tau_AI').value);
            params.tau_R = parseFloat(document.getElementById('tau_R').value);
            params.ubi_start_year = parseInt(document.getElementById('ubi_start_year').value);
            params.ubi_share_us = parseFloat(document.getElementById('ubi_share_us').value);
            params.ubi_share_world = parseFloat(document.getElementById('ubi_share_world').value);
        } else {
            // Default to zero taxes
            params.tau_k = 0;
            params.tau_AI = 0;
            params.tau_R = 0;
            params.ubi_start_year = 9999;
            params.ubi_share_us = 0;
            params.ubi_share_world = 0;
        }

        if (isPredictedOutputMode()) {
            params.savings_rate = parseFloat(document.getElementById('savings_rate').value);
            params.initial_KY_ratio = parseFloat(document.getElementById('initial_KY_ratio').value);
        }

        if (isIncomeDistributionMode()) {
            // Read empirical CDF breakpoints for each asset class
            // Each is [L(0.01), L(0.25), L(0.50), L(0.75), L(0.90), L(0.99), L(0.999)]
            params.cdf_wage = [
                parseFloat(document.getElementById('cdf_wage_1').value),
                parseFloat(document.getElementById('cdf_wage_25').value),
                parseFloat(document.getElementById('cdf_wage_50').value),
                parseFloat(document.getElementById('cdf_wage_75').value),
                parseFloat(document.getElementById('cdf_wage_90').value),
                parseFloat(document.getElementById('cdf_wage_99').value),
                parseFloat(document.getElementById('cdf_wage_999').value)
            ];
            params.cdf_capital = [
                parseFloat(document.getElementById('cdf_capital_1').value),
                parseFloat(document.getElementById('cdf_capital_25').value),
                parseFloat(document.getElementById('cdf_capital_50').value),
                parseFloat(document.getElementById('cdf_capital_75').value),
                parseFloat(document.getElementById('cdf_capital_90').value),
                parseFloat(document.getElementById('cdf_capital_99').value),
                parseFloat(document.getElementById('cdf_capital_999').value)
            ];
            params.cdf_ai = [
                parseFloat(document.getElementById('cdf_ai_1').value),
                parseFloat(document.getElementById('cdf_ai_25').value),
                parseFloat(document.getElementById('cdf_ai_50').value),
                parseFloat(document.getElementById('cdf_ai_75').value),
                parseFloat(document.getElementById('cdf_ai_90').value),
                parseFloat(document.getElementById('cdf_ai_99').value),
                parseFloat(document.getElementById('cdf_ai_999').value)
            ];
            params.cdf_robot = [
                parseFloat(document.getElementById('cdf_robot_1').value),
                parseFloat(document.getElementById('cdf_robot_25').value),
                parseFloat(document.getElementById('cdf_robot_50').value),
                parseFloat(document.getElementById('cdf_robot_75').value),
                parseFloat(document.getElementById('cdf_robot_90').value),
                parseFloat(document.getElementById('cdf_robot_99').value),
                parseFloat(document.getElementById('cdf_robot_999').value)
            ];
            params.cdf_land = [
                parseFloat(document.getElementById('cdf_land_1').value),
                parseFloat(document.getElementById('cdf_land_25').value),
                parseFloat(document.getElementById('cdf_land_50').value),
                parseFloat(document.getElementById('cdf_land_75').value),
                parseFloat(document.getElementById('cdf_land_90').value),
                parseFloat(document.getElementById('cdf_land_99').value),
                parseFloat(document.getElementById('cdf_land_999').value)
            ];
            // Income multiplier curves for distribution charts
            var _mp = [5, 10, 25, 50, 75, 90, 95, 99, 99.9];
            function readMults(prefix) {
                var pctIds = ['5','10','25','50','75','90','95','99','999'];
                return { pcts: _mp, vals: pctIds.map(function(s) { return parseFloat(document.getElementById(prefix + s).value) || 0; }) };
            }
            params.mult_wage = readMults('mult_wage_');
            params.mult_capital = readMults('mult_capital_');
            params.mult_ai = readMults('mult_ai_');
            params.mult_robot = readMults('mult_robot_');
            params.mult_land = readMults('mult_land_');

            // Distribution always reads tax/UBI params (independent of taxation toggle)
            params.dist_tau_k = parseFloat(document.getElementById('tau_k').value);
            params.dist_tau_AI = parseFloat(document.getElementById('tau_AI').value);
            params.dist_tau_R = parseFloat(document.getElementById('tau_R').value);
            params.dist_ubi_start_year = parseInt(document.getElementById('ubi_start_year').value);
            params.dist_ubi_share_us = parseFloat(document.getElementById('ubi_share_us').value);
            params.dist_ubi_share_world = parseFloat(document.getElementById('ubi_share_world').value);

            // LFP model parameters
            params.lfp_target = parseFloat(document.getElementById('lfp_target').value);
            params.logistic_s = parseFloat(document.getElementById('logistic_s').value);
            params.k_ubi = parseFloat(document.getElementById('k_ubi').value);
            params.labor_damp = parseFloat(document.getElementById('labor_damp').value);
        }

        return params;
    }

    // ========================================
    // CSV Parsing
    // ========================================

    function parseCell(x) {
        if (x === null || x === undefined || x === '') return NaN;

        const s = String(x).trim();
        if (s === '' || s.toLowerCase() === 'nan') return NaN;

        // Percentage
        if (s.endsWith('%')) {
            return parseFloat(s.slice(0, -1)) / 100.0;
        }

        // Remove $ and commas
        let s2 = s.replace(/\$/g, '').replace(/,/g, '').trim();

        // Match number with optional suffix
        const match = s2.match(/^([-+]?\d*\.?\d+)([KMBT])?$/i);
        if (match) {
            let num = parseFloat(match[1]);
            const suf = match[2];
            if (suf) {
                const mult = { 'K': 1e3, 'M': 1e6, 'B': 1e9, 'T': 1e12 };
                num *= mult[suf.toUpperCase()];
            }
            return num;
        }

        return parseFloat(s2);
    }

    function parseCSV(csvText) {
        const result = Papa.parse(csvText, {
            header: false,
            skipEmptyLines: false
        });

        const rows = result.data;
        if (rows.length === 0) {
            throw new Error("Empty CSV file");
        }

        // First row should be headers with years
        const headerRow = rows[0];
        const yearCols = [];
        const years = [];

        for (let i = 0; i < headerRow.length; i++) {
            const val = String(headerRow[i]).trim();
            if (/^\d{4}$/.test(val)) {
                yearCols.push(i);
                years.push(parseInt(val));
            }
        }

        if (years.length === 0) {
            throw new Error("No year columns found in the header row");
        }

        // Build label to series map
        const labelToSeries = {};
        for (let r = 1; r < rows.length; r++) {
            const row = rows[r];
            if (!row || !row[0]) continue;

            const label = String(row[0]).trim();
            if (!label) continue;

            const series = yearCols.map(i => parseCell(row[i]));
            labelToSeries[label] = series;
        }

        // Column name mappings (new template names -> internal names)
        // Support both old format and new simplified format
        const columnMappings = {
            // Human labor
            "Human Labor Force": "H",
            "US Human Labor Force": "H",
            // Working age population (for endogenous labor supply)
            "Human Working Age Population": "WorkingAgePop",
            // AI/Robot component rows
            "AI Copies": "ai_copies",
            "Human-equivs per AI Copy": "equivs_per_ai",
            "Robots": "robots",
            "Human-equivs per Robot": "equivs_per_robot",
            // AI/Robot aggregate (backwards compat with old CSVs)
            "AI Cognitive": "AI_cog_direct",
            "US AI cognitive": "AI_cog_direct",
            "Robotic Physical": "R_phys_direct",
            "US RObotic physical": "R_phys_direct",
            // Output
            "Output": "Y",
            "US Economy": "Y",
            // Capital
            "Capital": "K",
            "US 'Normal' Capital": "K",
            // Cognitive automation frontier
            "Cognitive Automation Frontier": "bar_auto_c",
            "% of cognitive jobs that can be automated": "bar_auto_c",
            // Physical automation frontier
            "Physical Automation Frontier": "bar_auto_p",
            "% of physical jobs that can be automated": "bar_auto_p",
            // US share rows
            "US Share of Compute": "us_share_compute",
            "US Share of Robots": "us_share_robots"
        };

        // Map labels to internal names
        const mappedSeries = {};
        for (const [label, series] of Object.entries(labelToSeries)) {
            if (columnMappings[label]) {
                mappedSeries[columnMappings[label]] = series;
            }
        }

        // Compute AI_cog and R_phys from component rows if available, else use direct
        if (mappedSeries["ai_copies"] && mappedSeries["equivs_per_ai"]) {
            mappedSeries["AI_cog"] = mappedSeries["ai_copies"].map(function(v, i) {
                return v * mappedSeries["equivs_per_ai"][i];
            });
        } else if (mappedSeries["AI_cog_direct"]) {
            mappedSeries["AI_cog"] = mappedSeries["AI_cog_direct"];
        }
        if (mappedSeries["robots"] && mappedSeries["equivs_per_robot"]) {
            mappedSeries["R_phys"] = mappedSeries["robots"].map(function(v, i) {
                return v * mappedSeries["equivs_per_robot"][i];
            });
        } else if (mappedSeries["R_phys_direct"]) {
            mappedSeries["R_phys"] = mappedSeries["R_phys_direct"];
        }

        // Check required fields
        const requiredFields = ["H", "AI_cog", "R_phys", "Y", "K", "bar_auto_c", "bar_auto_p"];
        const missingFields = requiredFields.filter(f => !mappedSeries[f]);

        if (missingFields.length > 0) {
            throw new Error(`Missing required rows. Please ensure your CSV has: Human Labor Force, AI Copies, Human-equivs per AI Copy, Robots, Human-equivs per Robot, Output, Capital, Cognitive Automation Frontier, Physical Automation Frontier`);
        }

        // Build data array
        const data = [];
        for (let i = 0; i < years.length; i++) {
            data.push({
                year: years[i],
                Y: mappedSeries["Y"][i],
                K: mappedSeries["K"][i],
                H_cog: mappedSeries["H"][i],
                H_phys: mappedSeries["H"][i],
                H_data: mappedSeries["H"][i],
                WorkingAgePop: mappedSeries["WorkingAgePop"] ? mappedSeries["WorkingAgePop"][i] : null,
                AI_cog: mappedSeries["AI_cog"][i],
                R_phys: mappedSeries["R_phys"][i],
                bar_auto_c: mappedSeries["bar_auto_c"][i],
                bar_auto_p: mappedSeries["bar_auto_p"][i],
                // Pass through component values for table population
                ai_copies: mappedSeries["ai_copies"] ? mappedSeries["ai_copies"][i] : null,
                equivs_per_ai: mappedSeries["equivs_per_ai"] ? mappedSeries["equivs_per_ai"][i] : null,
                robots: mappedSeries["robots"] ? mappedSeries["robots"][i] : null,
                equivs_per_robot: mappedSeries["equivs_per_robot"] ? mappedSeries["equivs_per_robot"][i] : null,
                us_share_compute: mappedSeries["us_share_compute"] ? mappedSeries["us_share_compute"][i] : null,
                us_share_robots: mappedSeries["us_share_robots"] ? mappedSeries["us_share_robots"][i] : null
            });
        }

        return data;
    }

    // ========================================
    // Editable Scenario Table
    // ========================================

    function buildScenarioTable(rowData, years, shareRows) {
        const wrapper = document.getElementById('scenarioTableWrapper');
        var allRows = rowData.slice();
        if (shareRows) {
            allRows = allRows.concat(shareRows);
        }

        // Pre-compute derived row initial values from editable rows
        var editableValues = {};
        allRows.forEach(function(row) {
            if (!row.derived && row.values) {
                editableValues[row.label] = row.values.map(function(v) { return parseCell(v); });
            }
        });

        let html = '<table id="scenarioTable"><thead><tr><th>Variable</th>';
        for (const y of years) {
            html += '<th>' + y + '</th>';
        }
        html += '</tr></thead><tbody>';

        for (let r = 0; r < allRows.length; r++) {
            const row = allRows[r];
            var isDerived = !!row.derived;
            var isBold = !!row.bold;
            var labelStyle = isBold ? ' style="font-weight:700;"' : '';
            var rowStyle = isDerived ? ' style="background:#f0f0f0;"' : '';
            html += '<tr data-row-label="' + row.label + '"' + rowStyle + '>';
            html += '<td' + labelStyle + '>' + row.label + '</td>';

            if (isDerived) {
                var computed = row.compute ? row.compute(editableValues) : null;
                for (let c = 0; c < years.length; c++) {
                    var displayVal = (computed && computed[c] != null) ? formatForDisplay(computed[c], '') : '';
                    html += '<td' + labelStyle + '><span class="derived-cell" data-row="' + r + '" data-col="' + c + '">' + displayVal + '</span></td>';
                }
            } else {
                for (let c = 0; c < years.length; c++) {
                    html += '<td' + labelStyle + '><input type="text" value="' + row.values[c] + '" data-row="' + r + '" data-col="' + c + '"' + (isBold ? ' style="font-weight:700;"' : '') + '></td>';
                }
            }
            html += '</tr>';
        }

        html += '</tbody></table>';
        wrapper.innerHTML = html;

        // Wire up live recalculation of derived rows on any input change
        var table = document.getElementById('scenarioTable');
        table.addEventListener('input', function() {
            recalcDerivedRows(allRows, years);
        });
    }

    function recalcDerivedRows(allRows, years) {
        var table = document.getElementById('scenarioTable');
        if (!table) return;

        // Read current editable values from the table
        var editableValues = {};
        var trs = table.querySelectorAll('tbody tr');
        trs.forEach(function(tr) {
            var label = tr.getAttribute('data-row-label');
            var matchRow = allRows.find(function(r) { return r.label === label; });
            if (matchRow && !matchRow.derived) {
                var inputs = tr.querySelectorAll('input');
                editableValues[label] = Array.from(inputs).map(function(inp) { return parseCell(inp.value); });
            }
        });

        // Update derived rows
        trs.forEach(function(tr) {
            var label = tr.getAttribute('data-row-label');
            var matchRow = allRows.find(function(r) { return r.label === label; });
            if (matchRow && matchRow.derived && matchRow.compute) {
                var computed = matchRow.compute(editableValues);
                var spans = tr.querySelectorAll('.derived-cell');
                spans.forEach(function(span, c) {
                    span.textContent = (computed && computed[c] != null) ? formatForDisplay(computed[c], '') : '';
                });
            }
        });
    }

    // Show/hide share rows in the scenario table based on region mode
    // All share rows are always in the DOM so readTableDataForRegion can access them
    function updateShareRowVisibility() {
        var table = document.getElementById('scenarioTable');
        if (!table) return;
        var mode = getRegionMode();
        var usLabels = ["US Share of Compute", "US Share of Robots"];
        var cnLabels = ["China Share of Compute", "China Share of Robots"];
        table.querySelectorAll('tbody tr').forEach(function(tr) {
            var label = tr.getAttribute('data-row-label');
            if (usLabels.indexOf(label) !== -1) {
                tr.style.display = (mode === 'us') ? '' : 'none';
            } else if (cnLabels.indexOf(label) !== -1) {
                tr.style.display = (mode === 'china') ? '' : 'none';
            }
        });
    }

    function readTableData() {
        const table = document.getElementById('scenarioTable');
        if (!table) throw new Error("Scenario table not found");

        const rows = table.querySelectorAll('tbody tr');
        const years = TEMPLATE_YEARS;

        // Read all table rows into a label->series map
        const allLabels = [
            "AI Copies", "Human-equivs per AI Copy", "AI Copies per H100e",
            "Robots", "Human-equivs per Robot",
            "Cognitive Automation Frontier", "Physical Automation Frontier",
            "US Share of Compute", "US Share of Robots",
            "China Share of Compute", "China Share of Robots"
        ];
        const tableSeries = {};
        rows.forEach(function(tr) {
            const label = tr.getAttribute('data-row-label');
            if (allLabels.indexOf(label) === -1) return;
            const inputs = tr.querySelectorAll('input');
            tableSeries[label] = Array.from(inputs).map(function(inp) { return parseCell(inp.value); });
        });

        // Mark invalid cells
        var hasInvalid = false;
        rows.forEach(function(tr) {
            const label = tr.getAttribute('data-row-label');
            if (allLabels.indexOf(label) === -1) return;
            const inputs = tr.querySelectorAll('input');
            inputs.forEach(function(inp) {
                var val = parseCell(inp.value);
                if (isNaN(val)) {
                    inp.classList.add('invalid');
                    hasInvalid = true;
                } else {
                    inp.classList.remove('invalid');
                }
            });
        });
        if (hasInvalid) {
            throw new Error("Invalid value(s) in input rows. Check highlighted cells.");
        }

        // Compute AI_cog = AI Copies  Human-equivs per AI Copy
        // Compute R_phys = Robots  Human-equivs per Robot
        var aiCopies = tableSeries["AI Copies"];
        var equivsPerAI = tableSeries["Human-equivs per AI Copy"];
        var robots = tableSeries["Robots"];
        var equivsPerRobot = tableSeries["Human-equivs per Robot"];

        if (!aiCopies || !equivsPerAI || !robots || !equivsPerRobot) {
            throw new Error("Missing component rows in the scenario table");
        }

        // In country mode, apply shares to quantities
        var regionMode = getRegionMode();
        if (regionMode === 'us' && tableSeries["US Share of Compute"] && tableSeries["US Share of Robots"]) {
            var computeShare = tableSeries["US Share of Compute"];
            var robotShare = tableSeries["US Share of Robots"];
            aiCopies = aiCopies.map(function(v, i) { return v * computeShare[i]; });
            robots = robots.map(function(v, i) { return v * robotShare[i]; });
        } else if (regionMode === 'china' && tableSeries["China Share of Compute"] && tableSeries["China Share of Robots"]) {
            var computeShare = tableSeries["China Share of Compute"];
            var robotShare = tableSeries["China Share of Robots"];
            aiCopies = aiCopies.map(function(v, i) { return v * computeShare[i]; });
            robots = robots.map(function(v, i) { return v * robotShare[i]; });
        }

        var AI_cog = aiCopies.map(function(v, i) { return v * equivsPerAI[i]; });
        var R_phys = robots.map(function(v, i) { return v * equivsPerRobot[i]; });

        // AI Copies per H100e from table (compute inverse for h100e_per_ai_copy)
        var copiesPerH100e = tableSeries["AI Copies per H100e"];
        var h100ePerAICopy = copiesPerH100e
            ? copiesPerH100e.map(function(v) { return v > 0 ? 1.0 / v : H100E_PER_AI_COPY[0]; })
            : H100E_PER_AI_COPY.slice();

        // Select background defaults based on mode
        var bgDefaults;
        if (regionMode === 'us') bgDefaults = BACKGROUND_DEFAULTS_US;
        else if (regionMode === 'china') bgDefaults = BACKGROUND_DEFAULTS_CHINA;
        else bgDefaults = BACKGROUND_DEFAULTS_GLOBAL;
        var bgMappings = {
            "Human Labor Force": "H",
            "Human Working Age Population": "WorkingAgePop",
            "Output": "Y",
            "Capital": "K"
        };
        var mappedSeries = {};
        for (var label in bgMappings) {
            if (bgDefaults[label]) {
                mappedSeries[bgMappings[label]] = bgDefaults[label].map(function(v) { return parseCell(v); });
            }
        }

        // Override base-year values from the editable inputs
        var baseY = parseCell(document.getElementById('base_Y').value);
        var baseL = parseCell(document.getElementById('base_L').value);
        var baseWAP = parseCell(document.getElementById('base_WAP').value);
        if (!isNaN(baseY)) mappedSeries["Y"][0] = baseY;
        if (!isNaN(baseL)) mappedSeries["H"][0] = baseL;
        if (!isNaN(baseWAP) && mappedSeries["WorkingAgePop"]) mappedSeries["WorkingAgePop"][0] = baseWAP;

        // Build data array (identical to parseCSV output)
        var data = [];
        for (var i = 0; i < years.length; i++) {
            data.push({
                year: years[i],
                Y: mappedSeries["Y"][i],
                K: mappedSeries["K"][i],
                H_cog: mappedSeries["H"][i],
                H_phys: mappedSeries["H"][i],
                H_data: mappedSeries["H"][i],
                WorkingAgePop: mappedSeries["WorkingAgePop"] ? mappedSeries["WorkingAgePop"][i] : null,
                AI_cog: AI_cog[i],
                R_phys: R_phys[i],
                bar_auto_c: tableSeries["Cognitive Automation Frontier"][i],
                bar_auto_p: tableSeries["Physical Automation Frontier"][i],
                equivs_per_ai: equivsPerAI[i],
                equivs_per_robot: equivsPerRobot[i],
                h100e_per_ai_copy: h100ePerAICopy[i]
            });
        }

        return data;
    }

    // Read table data for a specific region (used by triple model run for GWP breakdown)
    // region: 'us', 'china', 'row', or 'global'
    function readTableDataForRegion(region) {
        var table = document.getElementById('scenarioTable');
        if (!table) throw new Error("Scenario table not found");
        var rows = table.querySelectorAll('tbody tr');
        var years = TEMPLATE_YEARS;

        var allLabels = [
            "AI Copies", "Human-equivs per AI Copy", "AI Copies per H100e",
            "Robots", "Human-equivs per Robot",
            "Cognitive Automation Frontier", "Physical Automation Frontier",
            "US Share of Compute", "US Share of Robots",
            "China Share of Compute", "China Share of Robots"
        ];
        var tableSeries = {};
        rows.forEach(function(tr) {
            var label = tr.getAttribute('data-row-label');
            if (allLabels.indexOf(label) === -1) return;
            var inputs = tr.querySelectorAll('input');
            tableSeries[label] = Array.from(inputs).map(function(inp) { return parseCell(inp.value); });
        });

        var aiCopies = tableSeries["AI Copies"].slice();
        var equivsPerAI = tableSeries["Human-equivs per AI Copy"];
        var robots = tableSeries["Robots"].slice();
        var equivsPerRobot = tableSeries["Human-equivs per Robot"];

        // Apply region-specific shares
        if (region === 'us') {
            var cs = tableSeries["US Share of Compute"] || aiCopies.map(function() { return 0.8; });
            var rs = tableSeries["US Share of Robots"] || robots.map(function() { return 0.2; });
            aiCopies = aiCopies.map(function(v, i) { return v * cs[i]; });
            robots = robots.map(function(v, i) { return v * rs[i]; });
        } else if (region === 'china') {
            var cs = tableSeries["China Share of Compute"] || aiCopies.map(function() { return 0.1; });
            var rs = tableSeries["China Share of Robots"] || robots.map(function() { return 0.6; });
            aiCopies = aiCopies.map(function(v, i) { return v * cs[i]; });
            robots = robots.map(function(v, i) { return v * rs[i]; });
        } else if (region === 'row') {
            var usCS = tableSeries["US Share of Compute"] || aiCopies.map(function() { return 0.8; });
            var usRS = tableSeries["US Share of Robots"] || robots.map(function() { return 0.2; });
            var cnCS = tableSeries["China Share of Compute"] || aiCopies.map(function() { return 0.1; });
            var cnRS = tableSeries["China Share of Robots"] || robots.map(function() { return 0.6; });
            aiCopies = aiCopies.map(function(v, i) { return v * Math.max(0, 1 - usCS[i] - cnCS[i]); });
            robots = robots.map(function(v, i) { return v * Math.max(0, 1 - usRS[i] - cnRS[i]); });
        }
        // region === 'global'  no share adjustment

        var AI_cog = aiCopies.map(function(v, i) { return v * equivsPerAI[i]; });
        var R_phys = robots.map(function(v, i) { return v * equivsPerRobot[i]; });

        var copiesPerH100e = tableSeries["AI Copies per H100e"];
        var h100ePerAICopy = copiesPerH100e
            ? copiesPerH100e.map(function(v) { return v > 0 ? 1.0 / v : H100E_PER_AI_COPY[0]; })
            : H100E_PER_AI_COPY.slice();

        // Background defaults for this region
        var bgDefaults;
        if (region === 'us') bgDefaults = BACKGROUND_DEFAULTS_US;
        else if (region === 'china') bgDefaults = BACKGROUND_DEFAULTS_CHINA;
        else if (region === 'row') bgDefaults = computeRoWDefaults();
        else bgDefaults = BACKGROUND_DEFAULTS_GLOBAL;

        var bgMappings = { "Human Labor Force": "H", "Human Working Age Population": "WorkingAgePop", "Output": "Y", "Capital": "K" };
        var mappedSeries = {};
        for (var label in bgMappings) {
            if (bgDefaults[label]) {
                var vals = bgDefaults[label];
                mappedSeries[bgMappings[label]] = vals.map(function(v) { return typeof v === 'string' ? parseCell(v) : v; });
            }
        }

        var data = [];
        for (var i = 0; i < years.length; i++) {
            data.push({
                year: years[i],
                Y: mappedSeries["Y"][i],
                K: mappedSeries["K"][i],
                H_cog: mappedSeries["H"][i],
                H_phys: mappedSeries["H"][i],
                H_data: mappedSeries["H"][i],
                WorkingAgePop: mappedSeries["WorkingAgePop"] ? mappedSeries["WorkingAgePop"][i] : null,
                AI_cog: AI_cog[i],
                R_phys: R_phys[i],
                bar_auto_c: tableSeries["Cognitive Automation Frontier"][i],
                bar_auto_p: tableSeries["Physical Automation Frontier"][i],
                equivs_per_ai: equivsPerAI[i],
                equivs_per_robot: equivsPerRobot[i],
                h100e_per_ai_copy: h100ePerAICopy[i]
            });
        }
        return data;
    }

    function formatForDisplay(value, type) {
        if (value === null || isNaN(value)) return '';

        // Percentage fields
        if (type === 'bar_auto_c' || type === 'bar_auto_p') {
            return Math.round(value * 100) + '%';
        }

        // Numeric fields with suffix
        var abs = Math.abs(value);
        if (abs >= 1e12) return (value / 1e12).toFixed(1).replace(/\.0$/, '') + 'T';
        if (abs >= 1e9)  return (value / 1e9).toFixed(1).replace(/\.0$/, '') + 'B';
        if (abs >= 1e6)  return (value / 1e6).toFixed(1).replace(/\.0$/, '') + 'M';
        if (abs >= 1e3)  return (value / 1e3).toFixed(1).replace(/\.0$/, '') + 'K';
        if (abs >= 1)    return value.toFixed(1).replace(/\.0$/, '');
        if (abs >= 0.01) return value.toFixed(2).replace(/0+$/, '').replace(/\.$/, '');
        if (abs > 0)     return value.toFixed(3).replace(/0+$/, '').replace(/\.$/, '');
        return '0';
    }

    function populateTableFromLoadedData(data) {
        // Populate all editable rows from uploaded CSV data
        const labelToDataKey = {
            "AI Copies": { key: "ai_copies" },
            "Human-equivs per AI Copy": { key: "equivs_per_ai" },
            "Robots": { key: "robots" },
            "Human-equivs per Robot": { key: "equivs_per_robot" },
            "Cognitive Automation Frontier": { key: "bar_auto_c", type: "bar_auto_c" },
            "Physical Automation Frontier": { key: "bar_auto_p", type: "bar_auto_p" },
            "US Share of Compute": { key: "us_share_compute", type: "bar_auto_c" },
            "US Share of Robots": { key: "us_share_robots", type: "bar_auto_c" }
        };

        const table = document.getElementById('scenarioTable');
        const rows = table.querySelectorAll('tbody tr');

        rows.forEach(function(tr) {
            const label = tr.getAttribute('data-row-label');
            const mapping = labelToDataKey[label];
            if (!mapping) return;

            const inputs = tr.querySelectorAll('input');
            for (let i = 0; i < inputs.length && i < data.length; i++) {
                const val = data[i][mapping.key];
                if (val === null || val === undefined) continue;
                inputs[i].value = formatForDisplay(val, mapping.type);
                inputs[i].classList.remove('invalid');
            }
        });

        // Trigger derived row recalculation
        var evt = new Event('input', { bubbles: true });
        var firstInput = table.querySelector('tbody input');
        if (firstInput) firstInput.dispatchEvent(evt);
    }

    // ========================================
    // Charting
    // ========================================

    var wagesChart = null;
    var rentalCostChart = null;
    var muChart = null;
    var ellChart = null;
    var capitalChart = null;
    var interestChart = null;
    var factorIncomeChart = null;
    var techChart = null;
    var laborChart = null;
    var wageIncomeChart = null;
    var ubiTransferChart = null;
    var outputChart = null;
    var gwpBreakdownChart = null;
    var laborProductivityChart = null;
    var landRentChart = null;
    var landUseShareChart = null;
    var landIncomeShareChart = null;
    var consumerBudgetChart = null;
    var incomeDistChart = null;
    var incomeCompChart = null;
    var netWorthChart = null;
    var giniChart = null;

    // Chart functions loaded from charts/*.js
    // Distribution cache variables (used by external chart modules)
    var _cachedDistribution = null;
    var _cachedDistLabels = null;
    var _cachedResults = null;
    var _cachedParams = null;

    // Consumer budget chart cache (used by percentile dropdown)
    var _cachedCBResults = null;
    var _cachedCBYears = null;

    // ========================================
    // Chart Download / Side Panel
    // ========================================

    // Download PNG
    document.addEventListener('click', function(e) {
        var btn = e.target.closest('.chart-download-btn');
        if (!btn) return;
        var chartId = btn.getAttribute('data-chart');
        var chartInstance = Chart.getChart(chartId);
        if (!chartInstance) return;
        var a = document.createElement('a');
        a.href = chartInstance.toBase64Image('image/png', 1);
        a.download = chartId + '.png';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    });

    // Side panel toggle
    document.getElementById('sidePanelToggle').addEventListener('click', function() {
        var panel = document.getElementById('sidePanel');
        var tab = document.getElementById('sidePanelToggle');
        var isCollapsed = panel.classList.toggle('collapsed');
        if (isCollapsed) {
            tab.classList.remove('open');
            tab.innerHTML = 'Advanced Parameters &#x25C0;';
        } else {
            tab.classList.add('open');
            tab.innerHTML = 'Close &#x25B6;';
        }
    });

    document.getElementById('runModelSidePanel').addEventListener('click', function() {
        document.getElementById('runModel').click();
    });

    function createResultsTable(results, useLand = false) {
        const container = document.getElementById('tableContainer');

        let html = '<table><thead><tr>';
        html += '<th>Year</th><th>r</th><th>K_Y/K</th><th>K_C/K</th><th>K_R/K</th><th>mu_h_c</th><th>mu_h_p</th><th>w_c</th><th>q_c</th><th>w_p</th><th>q_p</th>';
        if (useLand) {
            html += '<th>E_t</th><th>R_total</th><th>Land%E</th>';
            for (var ci = 0; ci < LAND_ENDOGENOUS_CATEGORIES.length; ci++) {
                html += '<th>v_' + LAND_ENDOGENOUS_CATEGORIES[ci].substring(0, 4) + '</th>';
            }
        }
        html += '</tr></thead><tbody>';

        for (const row of results) {
            html += '<tr>';
            html += `<td>${row.year}</td>`;
            html += `<td>${row.r.toExponential(2)}</td>`;
            html += `<td>${row.share_KY.toFixed(4)}</td>`;
            html += `<td>${row.share_KC.toFixed(4)}</td>`;
            html += `<td>${row.share_KR.toFixed(4)}</td>`;
            html += `<td>${row.mu_h_c.toFixed(4)}</td>`;
            html += `<td>${row.mu_h_p.toFixed(4)}</td>`;
            html += `<td>${row.wc.toExponential(2)}</td>`;
            html += `<td>${row.qc.toExponential(2)}</td>`;
            html += `<td>${row.wp.toExponential(2)}</td>`;
            html += `<td>${row.qr.toExponential(2)}</td>`;
            if (useLand) {
                html += `<td>${(row.E_t || 0).toExponential(2)}</td>`;
                html += `<td>${(row.R_total || 0).toExponential(2)}</td>`;
                html += `<td>${((row.land_exp_share || 0) * 100).toFixed(2)}%</td>`;
                for (var ci = 0; ci < LAND_ENDOGENOUS_CATEGORIES.length; ci++) {
                    var v = row.rent_per_ha ? row.rent_per_ha[LAND_ENDOGENOUS_CATEGORIES[ci]] : 0;
                    html += `<td>${v.toExponential(2)}</td>`;
                }
            }
            html += '</tr>';
        }

        html += '</tbody></table>';
        container.innerHTML = html;
        document.getElementById('resultsTable').classList.remove('hidden');
    }

    // ========================================
    // Main App Logic
    // ========================================

    let loadedData = null;

    function showStatus(message, type) {
        const statusEl = document.getElementById('status');
        statusEl.textContent = message;
        statusEl.className = 'status ' + type;
        statusEl.classList.remove('hidden');
    }

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const csvText = event.target.result;
                const parsed = parseCSV(csvText);
                populateTableFromLoadedData(parsed);
                showStatus(`Loaded ${parsed.length} years from "${file.name}". Review values in the table above.`, 'success');
            } catch (err) {
                showStatus('Error parsing file: ' + err.message, 'error');
            }
        };
        reader.readAsText(file);
    });

    // Lightweight model run: returns array of {year, Y_predicted} for GWP breakdown
    // Runs the same solver logic but skips land, distribution, and endogenous labor
    function runModelForOutput(data, params) {
        var results = [];
        var doPredicted = isPredictedOutputMode();

        // Clone params to avoid mutating shared state
        var p = Object.assign({}, params);

        if (doPredicted) {
            var K_0 = p.initial_KY_ratio * data[0].Y;
            var baseRowWithK = Object.assign({}, data[0], { K: K_0 });

            var baseResult = solveMuOneYear(baseRowWithK, p);
            var sigma_K = p.sigma_K || 1.0;
            if (Math.abs(sigma_K - 1.0) >= 1e-10) {
                p.K0_base = K_0;
                p.Leff0_base = baseResult.L_eff;
                baseResult = solveMuOneYear(baseRowWithK, p);
                p.Leff0_base = baseResult.L_eff;
            }

            var A = calibrateTFP(data[0].Y, baseResult.K_Y, baseResult.L_eff, p.alpha, p.sigma_K, p.K0_base, p.Leff0_base);

            var trust_H = p.trust_num_workers;
            var trust_s = null;
            var prev_H_trust = null;
            var prev_Y = data[0].Y;
            var prev_K = K_0;

            for (var i = 0; i < data.length; i++) {
                var row = data[i];
                var Y_t;

                var trustParams = null;
                if (row.year >= p.trust_start_year) {
                    if (trust_s === null) {
                        trust_s = calibrateTrustShare(prev_Y, 1.0 * trust_H, p.trust_initial_value, p.trust_sigma);
                    }
                    var C_trust = computeTrustEfficiency(row.year, p.trust_start_year, p.trust_C_2040);
                    trustParams = { s_trust: trust_s, sigma_trust: p.trust_sigma, C_trust: C_trust, H_trust_seed: trust_H, prev_H_trust: prev_H_trust, anchor_H_trust: (row.year === p.trust_start_year), active: true };
                }

                if (i === 0) {
                    Y_t = data[0].Y;
                } else {
                    var K_t = p.savings_rate * prev_Y + (1.0 - p.delta_K) * prev_K;
                    var rowWithK = Object.assign({}, row, { K: K_t });
                    var solution = solveYearWithPredictedOutput(rowWithK, p, A, prev_Y * 1.05, trustParams);
                    Y_t = solution.Y_predicted;
                    prev_K = K_t;
                    if (solution.H_trust) prev_H_trust = solution.H_trust;
                }

                results.push({ year: row.year, Y_predicted: Y_t });
                prev_Y = Y_t;
            }
        } else {
            // Spreadsheet mode: Y is taken directly from the data
            for (var i = 0; i < data.length; i++) {
                results.push({ year: data[i].year, Y_predicted: data[i].Y });
            }
        }
        return results;
    }

    document.getElementById('runModel').addEventListener('click', function() {
        try {
            loadedData = readTableData();
        } catch (err) {
            showStatus('Error reading scenario data: ' + err.message, 'error');
            return;
        }

        try {
            const useLand = isLandMode();
            const modeDescs = [];
            if (useLand) modeDescs.push('land');
            showStatus(`Running ${modeDescs.length ? modeDescs.join(' + ') + ' bottleneck' : 'baseline'} model...`, 'info');

            const params = getParams();

            // Prepare consumption-side land parameters if in land mode
            let landParams = null;
            if (useLand) {
                var landRegion = getRegionMode();
                var M_physical, total_land, cat_exp_share;
                if (landRegion === 'us') {
                    M_physical = Object.assign({}, LAND_AREAS_US);
                    total_land = TOTAL_LAND_HA_US;
                    cat_exp_share = CAT_EXP_SHARES_US;
                } else if (landRegion === 'china') {
                    M_physical = Object.assign({}, LAND_AREAS_CHINA);
                    total_land = TOTAL_LAND_HA_CHINA;
                    cat_exp_share = CAT_EXP_SHARES_CHINA;
                } else {
                    M_physical = Object.assign({}, LAND_AREAS_WORLD);
                    total_land = TOTAL_LAND_HA_WORLD;
                    cat_exp_share = CAT_EXP_SHARES_WORLD;
                }

                landParams = {
                    beta: params.beta,
                    eta_D: params.eta_D,
                    eta_S: params.eta_S,
                    land_exp_share: params.land_exp_share,
                    cat_exp_share: cat_exp_share,
                    protect_wilderness: params.protect_wilderness,
                    protect_commercial: params.protect_commercial,
                    land_dereg_year: params.land_dereg_year,
                    land_dereg_ramp: params.land_dereg_ramp,
                    M_wilderness_init: M_physical['wilderness'],
                    M_commercial_init: M_physical['commercial'],
                    total_land: total_land,
                    M_physical_init: Object.assign({}, M_physical)
                };
                // Calibration deferred until after base-year solve (needs E_0)
            }

            const useDistribution = isIncomeDistributionMode();
            const hasWorkingAgePop = loadedData[0].WorkingAgePop !== null;
            const doEndogenousLabor = useDistribution && hasWorkingAgePop;
            const doDistributionLabor = doEndogenousLabor; // alias for charts
            const doPredictedOutput = isPredictedOutputMode();

            // Pre-initialize households if distribution mode
            var distHouseholds = null;
            var distPopWeights = null;
            if (useDistribution) {
                distHouseholds = initializeHouseholds(params);
                // Population weight per bucket
                distPopWeights = [];
                for (var pw = 0; pw < 99; pw++) distPopWeights.push(0.01);
                for (var pw = 0; pw < 10; pw++) distPopWeights.push(0.001);
            }

            let results = [];

            if (doPredictedOutput) {
                // ========================================
                // PREDICTED OUTPUT MODE
                // ========================================
                const baseRow = loadedData[0];

                // Base year: K_0 = Y_0 / (Y/K ratio)
                const K_0 = params.initial_KY_ratio * baseRow.Y;
                const baseRowWithK = { ...baseRow, K: K_0 };

                // Solve base year to calibrate TFP (A)
                // Two-pass approach for CES normalization:
                // Pass 1: solve to get L_eff (for CES normalization constants)
                // Pass 2: re-solve with normalization active so shares =  at base year
                let baseResult;

                // Pass 1: initial solve to determine base-year K_Y and L_eff
                baseResult = solveMuOneYear(baseRowWithK, params);

                // Store CES normalization constants: K_total and L_eff
                // pricesGivenMuAndZ uses total K in the CES nest, so normalize by K_total
                // At base year: cesTaskAgg(K/K, L_eff/L_eff) = cesTaskAgg(1, 1) = 1
                // So r =   Y / K and total capital share = 
                const sigma_K = params.sigma_K || 1.0;
                if (Math.abs(sigma_K - 1.0) >= 1e-10) {
                    params.K0_base = K_0;  // Total base-year capital (matches pricesGivenMuAndZ's K input)
                    params.Leff0_base = baseResult.L_eff;
                    // Pass 2: re-solve with normalization active
                    baseResult = solveMuOneYear(baseRowWithK, params);
                    // Update Leff0_base to match pass 2's L_eff for exact normalization
                    params.Leff0_base = baseResult.L_eff;
                }

                // Endogenous labor: calibrate from base year
                var B_po = null;
                if (doEndogenousLabor) {
                    var wbar_0_po = computeAverageWage(baseResult.wc, baseResult.wp, baseResult.ell_c);
                    var L_0_po = baseRow.H_data;
                    // Set wbar0 for new LFP model (distribution mode)
                    params.wbar0 = wbar_0_po;
                    // Keep legacy B calibration as fallback
                    B_po = calibrateLaborSupplyB(L_0_po, wbar_0_po, params.psi);
                }

                // Calibrate TFP: CES or Cobb-Douglas
                // With CES normalization: A = Y / cesTaskAgg(K_Y/K, 1) where K = total capital
                const A = calibrateTFP(baseRow.Y, baseResult.K_Y, baseResult.L_eff, params.alpha, params.sigma_K, params.K0_base, params.Leff0_base);

                // Trust share calibrated on first year of activation (needs actual Y at that point)
                const trust_H = params.trust_num_workers;
                var trust_s = null;
                var prev_H_trust_val = null;  // Track H_trust across years for iteration seeding

                // Process each year
                let prev_Y = baseRow.Y;
                let prev_K = K_0;

                // Calibrate land base year after first solve (needs savings rate to get E_0)
                if (landParams) {
                    var s_rate_base = params.savings_rate || 0.2;
                    var E_0_land = (1 - s_rate_base) * baseRow.Y;
                    var calibResult = calibrateLandBaseYear(E_0_land, landParams.M_physical_init, landParams);
                    landParams.A = calibResult.A;
                    landParams.B = calibResult.B;
                }

                for (let i = 0; i < loadedData.length; i++) {
                    const row = loadedData[i];
                    let solution;
                    let K_t, Y_t;

                    // Build trusted labor params for this year (H_trust solved endogenously)
                    var trustParams = null;
                    if (row.year >= params.trust_start_year) {
                        // Calibrate s_trust on first activation year using actual Y
                        if (trust_s === null) {
                            trust_s = calibrateTrustShare(
                                prev_Y,
                                1.0 * trust_H,
                                params.trust_initial_value,
                                params.trust_sigma
                            );
                        }
                        var C_trust = computeTrustEfficiency(row.year, params.trust_start_year, params.trust_C_2040);
                        trustParams = {
                            s_trust: trust_s,
                            sigma_trust: params.trust_sigma,
                            C_trust: C_trust,
                            H_trust_seed: trust_H,
                            prev_H_trust: prev_H_trust_val,
                            anchor_H_trust: (row.year === params.trust_start_year),
                            active: true
                        };
                    }

                    if (i === 0) {
                        // Base year: use spreadsheet Y and computed K_0
                        K_t = K_0;
                        Y_t = baseRow.Y;
                        solution = {
                            ...baseResult,
                            Y_predicted: Y_t,
                            Y_forecast: row.Y,
                            K_predicted: K_t,
                            K_forecast: row.K,
                            L_endogenous: baseRow.H_data,
                            participation_rate: baseRow.H_data / (row.WorkingAgePop || baseRow.H_data)
                        };
                    } else {
                        // Capital accumulation: K_t = s  Y_{t-1} + (1 - _K)  K_{t-1}
                        K_t = params.savings_rate * prev_Y + (1.0 - params.delta_K) * prev_K;

                        // Create row with predicted K
                        const rowWithK = { ...row, K: K_t };

                        // Use previous year's predicted Y as initial guess
                        const Y_guess = prev_Y * 1.05;

                        if (doEndogenousLabor) {
                            solution = solveYearWithPredictedOutputAndEndogenousLabor(
                                rowWithK, params, A, B_po, row.WorkingAgePop, Y_guess, trustParams
                            );
                        } else {
                            solution = solveYearWithPredictedOutput(rowWithK, params, A, Y_guess, trustParams);
                        }

                        Y_t = solution.Y_predicted;
                        solution.K_predicted = K_t;
                        solution.K_forecast = row.K;
                    }

                    // Consumption-side land equilibrium (post-solver)
                    if (landParams) {
                        var s_t = params.savings_rate || 0.2;
                        var E_t = (1 - s_t) * Y_t;
                        var landResult = solveLandEquilibrium(E_t, landParams, row.year);
                        solution.E_t = landResult.E_t;
                        solution.R_total = landResult.R_total;
                        solution.C_nonland = landResult.C_nonland;
                        solution.land_exp_share = landResult.land_exp_share;
                        solution.rent_per_ha = landResult.rent_per_ha;
                        solution.physical_land = landResult.physical_land;
                        solution.land_R = landResult.R;
                        solution.revenue_per_category = landResult.R;
                    }

                    results.push({
                        year: row.year,
                        ...row,
                        K: K_t,  // Override with predicted K
                        ...solution
                    });

                    prev_Y = Y_t;
                    prev_K = K_t;
                    if (solution.H_trust) prev_H_trust_val = solution.H_trust;
                }
            } else {
                // ========================================
                // SPREADSHEET MODE (original behavior)
                // ========================================

                // CES normalization: two-pass on base year to get K and L_eff
                const sigma_K_sp = params.sigma_K || 1.0;
                if (Math.abs(sigma_K_sp - 1.0) >= 1e-10) {
                    const baseRow_sp = loadedData[0];
                    // Pass 1: get base-year L_eff
                    const baseResult_sp1 = solveMuOneYear(baseRow_sp, params);
                    params.K0_base = baseRow_sp.K;  // Total base-year capital from spreadsheet
                    params.Leff0_base = baseResult_sp1.L_eff;
                    // Pass 2: re-solve with normalization and update L_eff
                    const baseResult_sp2 = solveMuOneYear(baseRow_sp, params);
                    params.Leff0_base = baseResult_sp2.L_eff;
                }

                // Calibrate land base year (spreadsheet mode)
                if (landParams) {
                    var s_rate_sp = params.savings_rate || 0.2;
                    var E_0_sp = (1 - s_rate_sp) * loadedData[0].Y;
                    var calibResult_sp = calibrateLandBaseYear(E_0_sp, landParams.M_physical_init, landParams);
                    landParams.A = calibResult_sp.A;
                    landParams.B = calibResult_sp.B;
                }

                // Calibrate trusted labor share using Y at trust start year
                const trust_H_sp = params.trust_num_workers;
                var trust_Y_sp = loadedData[0].Y;
                for (var ti = 0; ti < loadedData.length; ti++) {
                    if (loadedData[ti].year >= params.trust_start_year) {
                        trust_Y_sp = loadedData[ti].Y;
                        break;
                    }
                }
                const trust_s_sp = calibrateTrustShare(
                    trust_Y_sp,
                    1.0 * trust_H_sp,
                    params.trust_initial_value,
                    params.trust_sigma
                );

                // Helper to build per-year trustParams (H_trust solved endogenously)
                var prev_H_trust_sp = null;
                function buildTrustParams_sp(year) {
                    if (year < params.trust_start_year) return null;
                    var C_trust = computeTrustEfficiency(year, params.trust_start_year, params.trust_C_2040);
                    return {
                        s_trust: trust_s_sp,
                        sigma_trust: params.trust_sigma,
                        C_trust: C_trust,
                        H_trust_seed: trust_H_sp,
                        prev_H_trust: prev_H_trust_sp,
                        anchor_H_trust: (year === params.trust_start_year),
                        active: true
                    };
                }

                if (doEndogenousLabor) {
                    // Endogenous labor supply
                    const baseRow = loadedData[0];
                    const baseResult = solveMuOneYear(baseRow, params);
                    var wbar_0_sp = computeAverageWage(baseResult.wc, baseResult.wp, baseResult.ell_c);
                    var L_0_sp = baseRow.H_data;
                    // Set wbar0 for new LFP model (distribution mode)
                    params.wbar0 = wbar_0_sp;
                    // Keep legacy B calibration as fallback
                    var B_sp = calibrateLaborSupplyB(L_0_sp, wbar_0_sp, params.psi);

                    for (let i = 0; i < loadedData.length; i++) {
                        const row = loadedData[i];
                        const workingAgePop = row.WorkingAgePop;
                        const trustParams = buildTrustParams_sp(row.year);
                        const solution = solveWithEndogenousLabor(row, params, B_sp, workingAgePop, trustParams);

                        // Consumption-side land equilibrium (post-solver)
                        if (landParams) {
                            var s_t_sp = params.savings_rate || 0.2;
                            var E_t_sp = (1 - s_t_sp) * row.Y;
                            var landResult_sp = solveLandEquilibrium(E_t_sp, landParams, row.year);
                            solution.E_t = landResult_sp.E_t;
                            solution.R_total = landResult_sp.R_total;
                            solution.C_nonland = landResult_sp.C_nonland;
                            solution.land_exp_share = landResult_sp.land_exp_share;
                            solution.rent_per_ha = landResult_sp.rent_per_ha;
                            solution.physical_land = landResult_sp.physical_land;
                            solution.land_R = landResult_sp.R;
                            solution.revenue_per_category = landResult_sp.R;
                        }

                        results.push({
                            year: row.year,
                            ...row,
                            ...solution,
                            Y_predicted: row.Y,
                            Y_forecast: row.Y
                        });
                        if (solution.H_trust) prev_H_trust_sp = solution.H_trust;
                    }
                } else {
                    // Simple mode: use spreadsheet values directly
                    for (let i = 0; i < loadedData.length; i++) {
                        const row = loadedData[i];
                        const trustParams = buildTrustParams_sp(row.year);
                        const solution = solveMuOneYear(row, params, trustParams);

                        // Consumption-side land equilibrium (post-solver)
                        if (landParams) {
                            var s_t_simple = params.savings_rate || 0.2;
                            var E_t_simple = (1 - s_t_simple) * row.Y;
                            var landResult_simple = solveLandEquilibrium(E_t_simple, landParams, row.year);
                            solution.E_t = landResult_simple.E_t;
                            solution.R_total = landResult_simple.R_total;
                            solution.C_nonland = landResult_simple.C_nonland;
                            solution.land_exp_share = landResult_simple.land_exp_share;
                            solution.rent_per_ha = landResult_simple.rent_per_ha;
                            solution.physical_land = landResult_simple.physical_land;
                            solution.land_R = landResult_simple.R;
                            solution.revenue_per_category = landResult_simple.R;
                        }

                        results.push({
                            year: row.year,
                            ...row,
                            ...solution,
                            Y_predicted: row.Y,
                            Y_forecast: row.Y
                        });
                        if (solution.H_trust) prev_H_trust_sp = solution.H_trust;
                    }
                }
            }

            const useTaxation = isTaxationMode();

            // GWP breakdown: always run model for all 3 regions
            var gwpBreakdown = null;
            try {
                var dataUS = readTableDataForRegion('us');
                var dataCN = readTableDataForRegion('china');
                var dataRoW = readTableDataForRegion('row');
                gwpBreakdown = {
                    us: runModelForOutput(dataUS, params),
                    china: runModelForOutput(dataCN, params),
                    row: runModelForOutput(dataRoW, params)
                };
            } catch (e) {
                console.warn('GWP breakdown failed:', e.message);
            }

            // Income distribution post-processing (charts only  labor already integrated)
            if (useDistribution) {
                var distribution = computeIncomeDistribution(results, distHouseholds, params);
                createCharts(results, useLand, doDistributionLabor, useTaxation, gwpBreakdown);
                createDistributionCharts(distribution, results, params);
            } else {
                createCharts(results, useLand, doDistributionLabor, useTaxation, gwpBreakdown);
                createDistributionCharts(null, null, null);
            }

            createResultsTable(results, useLand);

            const bottlenecks = [];
            if (useLand) bottlenecks.push('land');
            const modeStr = bottlenecks.length ? bottlenecks.join(' + ') + ' bottleneck' : 'baseline';
            const laborStr = doEndogenousLabor ? ' with endogenous labor' : '';
            const taxStr = useTaxation ? ' with taxation' : '';
            const predictStr = doPredictedOutput ? ' with predicted Y & K' : '';
            const distStr = useDistribution ? ' with income distribution' : '';
            showStatus(`Model (${modeStr}${laborStr}${taxStr}${predictStr}${distStr}) completed successfully!`, 'success');
        } catch (err) {
            showStatus('Error running model: ' + err.message, 'error');
            console.error(err);
        }
    });

    // Toggle land parameter visibility
    document.getElementById('useLand').addEventListener('change', function() {
        const useLand = this.checked;
        document.getElementById('landParams').classList.toggle('hidden', !useLand);
    });

    // Toggle tax parameters visibility
    document.getElementById('useTaxation').addEventListener('change', function() {
        const useTaxation = this.checked;
        document.getElementById('taxParams').classList.toggle('hidden', !useTaxation);
        document.getElementById('taxParamsInner').classList.toggle('hidden', !useTaxation);
    });

    // Toggle capital accumulation parameters visibility
    document.getElementById('usePredictedOutput').addEventListener('change', function() {
        const usePredictedOutput = this.checked;
        document.getElementById('capitalAccumParams').classList.toggle('hidden', !usePredictedOutput);
    });

    // Toggle income distribution parameters visibility
    document.getElementById('useIncomeDistribution').addEventListener('change', function() {
        document.getElementById('incomeDistParams').classList.toggle('hidden', !this.checked);
        // Toggle labor supply parameter visibility: psi when dist off, LFP params when dist on
        document.getElementById('psiParams').classList.toggle('hidden', this.checked);
        document.getElementById('lfpParams').classList.toggle('hidden', !this.checked);
    });

    // Income composition year toggle
    document.getElementById('incomeCompYearSelect').addEventListener('change', function() {
        if (_cachedDistribution && _cachedDistLabels && _cachedResults && _cachedParams) {
            buildIncomeCompChart(_cachedDistribution, parseInt(this.value), _cachedDistLabels, _cachedResults, _cachedParams);
        }
    });

    // Consumer budget percentile toggle
    document.getElementById('consumerBudgetPctSelect').addEventListener('change', function() {
        if (_cachedCBResults && _cachedCBYears) {
            if (consumerBudgetChart) consumerBudgetChart.destroy();
            var cbParams = getParams();
            var cbPct = document.getElementById('consumerBudgetPctSelect').value;
            consumerBudgetChart = createConsumerBudgetChart(_cachedCBResults, _cachedCBYears, cbParams, cbPct);
        }
    });

    // Consumer budget inline allocation controls
    function rebuildConsumerBudget() {
        if (_cachedCBResults && _cachedCBYears) {
            if (consumerBudgetChart) consumerBudgetChart.destroy();
            var cbParams = getParams();
            var cbPct = document.getElementById('consumerBudgetPctSelect').value;
            consumerBudgetChart = createConsumerBudgetChart(_cachedCBResults, _cachedCBYears, cbParams, cbPct);
        }
    }
    ['cb_land_share', 'cb_ai_share', 'cb_urban_share'].forEach(function(id) {
        document.getElementById(id).addEventListener('change', rebuildConsumerBudget);
    });

    // Download CSV (exports table + background defaults)
    document.getElementById('downloadTemplate').addEventListener('click', function() {
        const table = document.getElementById('scenarioTable');
        const rows = table.querySelectorAll('tbody tr');
        var regionMode = getRegionMode();
        var bgDefaults;
        if (regionMode === 'us') bgDefaults = BACKGROUND_DEFAULTS_US;
        else if (regionMode === 'china') bgDefaults = BACKGROUND_DEFAULTS_CHINA;
        else bgDefaults = BACKGROUND_DEFAULTS_GLOBAL;

        var csv = ',' + TEMPLATE_YEARS.join(',') + '\n';

        // Only export Working Age Population from background defaults
        if (bgDefaults["Human Working Age Population"]) {
            csv += 'Human Working Age Population,' + bgDefaults["Human Working Age Population"].join(',') + '\n';
        }

        // Editable rows from table
        rows.forEach(function(tr) {
            var label = tr.getAttribute('data-row-label');
            var inputs = tr.querySelectorAll('input');
            var values = Array.from(inputs).map(function(inp) { return inp.value.trim(); });
            csv += label + ',' + values.join(',') + '\n';
        });

        var blob = new Blob([csv], { type: 'text/csv' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'default_scenario.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

    // Get template rows for current mode
    function getTemplateRowsForMode() {
        return TEMPLATE_ROWS;
    }

    // Load default_scenario.csv, apply values to TEMPLATE_ROWS/BACKGROUND_DEFAULTS, rebuild table
    function loadDefaultCSV(callback) {
        fetch('default_scenario.csv?' + Date.now())
            .then(function(resp) {
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                return resp.text();
            })
            .then(function(csvText) {
                var parsed = Papa.parse(csvText, { header: false, skipEmptyLines: true });
                if (!parsed.data || parsed.data.length < 2) throw new Error('Empty CSV');
                var headerRow = parsed.data[0];
                // Build label  string[] map
                var csvMap = {};
                for (var r = 1; r < parsed.data.length; r++) {
                    var row = parsed.data[r];
                    var label = String(row[0]).trim();
                    if (!label) continue;
                    csvMap[label] = row.slice(1);
                }
                // Override TEMPLATE_ROWS values
                TEMPLATE_ROWS.forEach(function(tRow) {
                    if (!tRow.derived && csvMap[tRow.label]) {
                        tRow.values = csvMap[tRow.label];
                    }
                });
                // Override share rows values from CSV
                US_SHARE_ROWS.concat(CHINA_SHARE_ROWS).forEach(function(sRow) {
                    if (csvMap[sRow.label]) {
                        sRow.values = csvMap[sRow.label];
                    }
                });
                // Override Working Age Population from CSV (other bg defaults remain hardcoded)
                if (csvMap["Human Working Age Population"]) {
                    BACKGROUND_DEFAULTS_US["Human Working Age Population"] = csvMap["Human Working Age Population"];
                }
                if (callback) callback(true);
            })
            .catch(function(err) {
                console.log('Could not load default_scenario.csv, using hardcoded defaults:', err.message);
                if (callback) callback(false);
            });
    }

    // Reset Defaults  reload from CSV
    document.getElementById('resetDefaults').addEventListener('click', function() {
        loadDefaultCSV(function() {
            buildScenarioTable(getTemplateRowsForMode(), TEMPLATE_YEARS, ALL_SHARE_ROWS);
            updateShareRowVisibility();
            updateBaseYearInputs();
            showStatus('Table reset to default values from default_scenario.csv.', 'info');
        });
    });

    // Populate base-year economy inputs from the appropriate defaults
    function updateBaseYearInputs() {
        var mode = getRegionMode();
        var bg;
        if (mode === 'us') bg = BACKGROUND_DEFAULTS_US;
        else if (mode === 'china') bg = BACKGROUND_DEFAULTS_CHINA;
        else bg = BACKGROUND_DEFAULTS_GLOBAL;

        document.getElementById('base_Y').value = bg["Output"][0];
        document.getElementById('base_L').value = bg["Human Labor Force"][0];
        document.getElementById('base_WAP').value = bg["Human Working Age Population"][0];

        // Swap income distribution CDF defaults
        var cdf;
        if (mode === 'us') cdf = CDF_DEFAULTS_US;
        else if (mode === 'china') cdf = CDF_DEFAULTS_CHINA;
        else cdf = CDF_DEFAULTS_WORLD;
        var cdfKeys = ['wage', 'capital', 'ai', 'robot', 'land'];
        var pctLabels = ['1', '25', '50', '75', '90', '99', '999'];
        cdfKeys.forEach(function(key) {
            pctLabels.forEach(function(pct, i) {
                var el = document.getElementById('cdf_' + key + '_' + pct);
                if (el) el.value = cdf[key][i];
            });
        });

        // Swap LFP defaults
        var lfp;
        if (mode === 'us') lfp = LFP_DEFAULTS_US;
        else if (mode === 'china') lfp = LFP_DEFAULTS_CHINA;
        else lfp = LFP_DEFAULTS_WORLD;
        document.getElementById('lfp_target').value = lfp.lfp_target;

        // Swap land expenditure share default
        var landExp;
        if (mode === 'us') landExp = LAND_EXP_SHARE_US;
        else if (mode === 'china') landExp = LAND_EXP_SHARE_CHINA;
        else landExp = LAND_EXP_SHARE_WORLD;
        document.getElementById('land_exp_share').value = landExp;

        // Swap trusted labor defaults by mode
        if (mode === 'us') {
            document.getElementById('trust_num_workers').value = 100000;
            document.getElementById('trust_avg_wage').value = 150000;
        } else if (mode === 'china') {
            document.getElementById('trust_num_workers').value = 100000;
            document.getElementById('trust_avg_wage').value = 80000;
        } else {
            document.getElementById('trust_num_workers').value = 200000;
            document.getElementById('trust_avg_wage').value = 115000;
        }
    }

    // Region toggle  rebuild table with all share rows, show/hide appropriate ones, update defaults
    document.querySelectorAll('input[name="regionMode"]').forEach(function(radio) {
        radio.addEventListener('change', function() {
            buildScenarioTable(getTemplateRowsForMode(), TEMPLATE_YEARS, ALL_SHARE_ROWS);
            updateShareRowVisibility();
            updateBaseYearInputs();
        });
    });

    // Initialize: build table with hardcoded defaults first, then overlay with CSV
    buildScenarioTable(getTemplateRowsForMode(), TEMPLATE_YEARS, ALL_SHARE_ROWS);
    updateShareRowVisibility();
    updateBaseYearInputs();
    loadDefaultCSV(function(loaded) {
        if (loaded) {
            buildScenarioTable(getTemplateRowsForMode(), TEMPLATE_YEARS, ALL_SHARE_ROWS);
            updateShareRowVisibility();
            updateBaseYearInputs();
        }
    });
    </script>
</body>
</html>
